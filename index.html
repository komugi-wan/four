<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Spreadsheet App</title>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .toolbar { background: #f3f3f3; padding: 10px; border-bottom: 1px solid #ccc; display: flex; gap: 10px; align-items: center; }
        .table-container { overflow: auto; flex-grow: 1; position: relative; }
        
        /* 修正点: table-layout: fixed は維持しつつ、リサイズを反映しやすく調整 */
        table { border-collapse: collapse; table-layout: fixed; width: max-content; } 
        th, td { border: 1px solid #ccc; position: relative; min-width: 80px; height: 25px; box-sizing: border-box; }
        
        /* Headers */
        th { background: #e8e8e8; font-size: 12px; font-weight: normal; user-select: none; overflow: hidden; }
        .row-header { width: 40px; text-align: center; }
        
        /* Cell Input */
        td input { 
            border: none; width: 100%; height: 100%; padding: 0 4px; 
            box-sizing: border-box; outline: none; font-size: 14px;
            display: block; /* 余白対策 */
        }
        td input:focus { border: 2px solid #1a73e8; margin: -1px; position: relative; z-index: 2; }

        /* Resizers */
        .resizer-h {
            position: absolute; right: 0; top: 0; width: 5px; height: 100%;
            cursor: col-resize; z-index: 10;
        }
        .resizer-v {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 5px;
            cursor: row-resize; z-index: 10;
        }
        .resizer-h:hover, .resizer-v:hover { background: #1a73e8; }

        button { cursor: pointer; padding: 5px 12px; background: #fff; border: 1px solid #ccc; border-radius: 4px; }
        button:hover { background: #eee; }
    </style>
</head>
<body>

<div class="toolbar">
    <button onclick="addRow()">行を追加 (+)</button>
    <button onclick="addCol()">列を追加 (+)</button>
    <button onclick="exportCSV()">CSV書き出し</button>
    <span style="font-size: 12px; color: #666;">※セルの端をドラッグしてサイズ変更可能</span>
</div>

<div class="table-container">
    <table id="spreadsheet">
        <thead>
            <tr id="header-row">
                <th class="row-header"></th>
                </tr>
        </thead>
        <tbody id="table-body">
            </tbody>
    </table>
</div>

<script>
    const table = document.getElementById('spreadsheet');
    const headerRow = document.getElementById('header-row');
    const tableBody = document.getElementById('table-body');
    
    let rowCount = 20;
    let colCount = 10;

    // A, B, C... Z, AA, AB... 形式の列名生成
    function getColName(n) {
        let name = "";
        while (n >= 0) {
            name = String.fromCharCode((n % 26) + 65) + name;
            n = Math.floor(n / 26) - 1;
        }
        return name;
    }

    // 初期テーブル構築
    function initTable() {
        for (let i = 0; i < colCount; i++) createColHeader(i);
        for (let i = 0; i < rowCount; i++) createRow(i);
    }

    function createColHeader(index) {
        const th = document.createElement('th');
        th.innerText = getColName(index);
        
        // 列幅リサイズ
        const resizer = document.createElement('div');
        resizer.className = 'resizer-h';
        resizer.addEventListener('mousedown', initResizeCol);
        th.appendChild(resizer);
        
        headerRow.appendChild(th);
    }

    function createRow(rowIndex) {
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.className = 'row-header';
        th.innerText = rowIndex + 1;
        
        // 行高さリサイズ
        const resizer = document.createElement('div');
        resizer.className = 'resizer-v';
        resizer.addEventListener('mousedown', initResizeRow);
        th.appendChild(resizer);
        
        tr.appendChild(th);

        for (let i = 0; i < colCount; i++) {
            const td = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'text';
            td.appendChild(input);
            tr.appendChild(td);
        }
        tableBody.appendChild(tr);
    }

    // 行と列の追加機能
    function addRow() {
        createRow(rowCount++);
    }

    function addCol() {
        createColHeader(colCount++);
        Array.from(tableBody.rows).forEach(row => {
            const td = document.createElement('td');
            td.appendChild(document.createElement('input'));
            row.appendChild(td);
        });
    }

    // リサイズ機能のロジック
    function initResizeCol(e) {
        const th = e.target.parentElement;
        const startX = e.pageX;
        const startWidth = th.offsetWidth;
        
        // 修正点: 視覚的に分かりやすくするため、リサイズ中にクラスを追加する等の拡張も可能ですが、
        // 今回は基本ロジックを確実に動作させるため、thの幅を直接変更します。
        function onMouseMove(e) {
            const newWidth = startWidth + e.pageX - startX;
            if (newWidth > 40) { // 最小幅の制限
                th.style.width = newWidth + 'px';
            }
        }
        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    function initResizeRow(e) {
        const th = e.target.parentElement;
        const tr = th.parentElement;
        const startY = e.pageY;
        const startHeight = tr.offsetHeight;

        function onMouseMove(e) {
            const newHeight = startHeight + e.pageY - startY;
            if (newHeight > 20) { // 最小高さの制限
                tr.style.height = newHeight + 'px';
            }
        }
        function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    // CSVエクスポート
    function exportCSV() {
        let csv = "";
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const cols = row.querySelectorAll('input');
            const rowData = Array.from(cols).map(input => `"${input.value}"`).join(",");
            csv += rowData + "\r\n";
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "data.csv";
        link.click();
    }

    initTable();
</script>

</body>
</html>
