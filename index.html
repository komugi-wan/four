<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Spreadsheet App</title>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        /* スマホ向けにボタンを押しやすく調整 */
        .toolbar { background: #f3f3f3; padding: 10px; border-bottom: 1px solid #ccc; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .table-container { overflow: auto; flex-grow: 1; position: relative; -webkit-overflow-scrolling: touch; }
        
        table { border-collapse: collapse; table-layout: fixed; width: max-content; } 
        th, td { border: 1px solid #ccc; position: relative; min-width: 80px; height: 30px; box-sizing: border-box; }
        
        /* Headers */
        th { background: #e8e8e8; font-size: 12px; font-weight: normal; user-select: none; overflow: visible; }
        .row-header { width: 40px; text-align: center; }
        
        /* Cell Input */
        td input { 
            border: none; width: 100%; height: 100%; padding: 0 4px; 
            box-sizing: border-box; outline: none; font-size: 16px; /* スマホでズームされないよう16px以上に */
            display: block;
        }
        td input:focus { border: 2px solid #1a73e8; margin: -1px; position: relative; z-index: 2; }

        /* Resizers - スマホ操作用に当たり判定を拡大 (15px) */
        .resizer-h {
            position: absolute; right: -5px; top: 0; width: 15px; height: 100%;
            cursor: col-resize; z-index: 10; touch-action: none;
        }
        .resizer-v {
            position: absolute; bottom: -5px; left: 0; width: 100%; height: 15px;
            cursor: row-resize; z-index: 10; touch-action: none;
        }
        /* 視覚的な線は細く保つ */
        .resizer-h::after { content: ''; position: absolute; right: 5px; top: 0; width: 2px; height: 100%; }
        .resizer-v::after { content: ''; position: absolute; bottom: 5px; left: 0; width: 100%; height: 2px; }
        
        .resizer-h:active::after, .resizer-v:active::after { background: #1a73e8; }

        button { cursor: pointer; padding: 8px 12px; background: #fff; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        button:hover { background: #eee; }
    </style>
</head>
<body>

<div class="toolbar">
    <button onclick="addRow()">行を追加 (+)</button>
    <button onclick="addCol()">列を追加 (+)</button>
    <button onclick="exportCSV()">CSV書き出し</button>
    <span style="font-size: 12px; color: #666;">※端をドラッグでリサイズ</span>
</div>

<div class="table-container">
    <table id="spreadsheet">
        <thead>
            <tr id="header-row">
                <th class="row-header"></th>
                </tr>
        </thead>
        <tbody id="table-body">
            </tbody>
    </table>
</div>

<script>
    const table = document.getElementById('spreadsheet');
    const headerRow = document.getElementById('header-row');
    const tableBody = document.getElementById('table-body');
    
    let rowCount = 20;
    let colCount = 10;

    function getColName(n) {
        let name = "";
        while (n >= 0) {
            name = String.fromCharCode((n % 26) + 65) + name;
            n = Math.floor(n / 26) - 1;
        }
        return name;
    }

    function initTable() {
        for (let i = 0; i < colCount; i++) createColHeader(i);
        for (let i = 0; i < rowCount; i++) createRow(i);
    }

    function createColHeader(index) {
        const th = document.createElement('th');
        th.innerText = getColName(index);
        
        const resizer = document.createElement('div');
        resizer.className = 'resizer-h';
        // マウスとタッチの両方に対応
        resizer.addEventListener('mousedown', initResizeCol);
        resizer.addEventListener('touchstart', initResizeCol, {passive: false});
        th.appendChild(resizer);
        
        headerRow.appendChild(th);
    }

    function createRow(rowIndex) {
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.className = 'row-header';
        th.innerText = rowIndex + 1;
        
        const resizer = document.createElement('div');
        resizer.className = 'resizer-v';
        resizer.addEventListener('mousedown', initResizeRow);
        resizer.addEventListener('touchstart', initResizeRow, {passive: false});
        th.appendChild(resizer);
        
        tr.appendChild(th);

        for (let i = 0; i < colCount; i++) {
            const td = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'text';
            td.appendChild(input);
            tr.appendChild(td);
        }
        tableBody.appendChild(tr);
    }

    function addRow() {
        createRow(rowCount++);
    }

    function addCol() {
        createColHeader(colCount++);
        Array.from(tableBody.rows).forEach(row => {
            const td = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'text';
            td.appendChild(input);
            row.appendChild(td);
        });
    }

    // 座標取得の共通化（マウス/タッチ両対応）
    function getClientX(e) {
        return e.touches ? e.touches[0].clientX : e.clientX;
    }
    function getClientY(e) {
        return e.touches ? e.touches[0].clientY : e.clientY;
    }

    function initResizeCol(e) {
        if (e.cancelable) e.preventDefault(); // スクロール防止
        const th = e.target.parentElement;
        const startX = getClientX(e);
        const startWidth = th.offsetWidth;
        
        function onMove(e) {
            const newWidth = startWidth + getClientX(e) - startX;
            if (newWidth > 40) {
                th.style.width = newWidth + 'px';
            }
        }
        function onEnd() {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onEnd);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onEnd);
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
        document.addEventListener('touchmove', onMove, {passive: false});
        document.addEventListener('touchend', onEnd);
    }

    function initResizeRow(e) {
        if (e.cancelable) e.preventDefault();
        const th = e.target.parentElement;
        const tr = th.parentElement;
        const startY = getClientY(e);
        const startHeight = tr.offsetHeight;

        function onMove(e) {
            const newHeight = startHeight + getClientY(e) - startY;
            if (newHeight > 20) {
                tr.style.height = newHeight + 'px';
            }
        }
        function onEnd() {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onEnd);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onEnd);
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
        document.addEventListener('touchmove', onMove, {passive: false});
        document.addEventListener('touchend', onEnd);
    }

    function exportCSV() {
        let csv = "";
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const cols = row.querySelectorAll('input');
            const rowData = Array.from(cols).map(input => `"${input.value}"`).join(",");
            csv += rowData + "\r\n";
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "data.csv";
        link.click();
    }

    initTable();
</script>

</body>
</html>
