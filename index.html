<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Spreadsheet App</title>
    <style>
        :root {
            --border-color: #ccc;
            --header-bg: #f8f9fa;
            --selection-blue: #1a73e8;
            --header-width: 50px;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* ツールバー */
        .toolbar { 
            background: #ffffff; 
            padding: 8px 16px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            gap: 12px; 
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        /* テーブルコンテナ */
        .table-container { 
            overflow: auto; 
            flex-grow: 1; 
            background: #f1f3f4;
        }
        
        table { 
            border-collapse: separate; 
            border-spacing: 0; 
            table-layout: fixed; 
            background: white;
            width: max-content;
        }

        /* ヘッダー(A,B,C... / 1,2,3...) */
        th { 
            background: var(--header-bg); 
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 2;
            font-size: 12px;
            font-weight: normal;
            color: #666;
            user-select: none;
        }

        .row-header { 
            left: 0; 
            z-index: 3; 
            width: var(--header-width);
            text-align: center;
        }

        th:first-child { z-index: 4; top: 0; left: 0; }

        /* セル */
        td { 
            border-right: 1px solid #e2e2e2; 
            border-bottom: 1px solid #e2e2e2; 
            padding: 0;
            vertical-align: middle;
        }

        td input { 
            border: none; 
            width: 100%; 
            height: 100%; 
            padding: 0 6px; 
            box-sizing: border-box; 
            outline: none; 
            font-size: 13px;
            background: transparent;
        }

        td input:focus { 
            box-shadow: inset 0 0 0 2px var(--selection-blue);
            background: #fff;
            z-index: 5;
            position: relative;
        }

        /* リサイザー */
        .resizer-h {
            position: absolute; right: 0; top: 0; width: 4px; height: 100%;
            cursor: col-resize;
        }
        .resizer-h:hover { border-right: 3px solid var(--selection-blue); }

        .resizer-v {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 4px;
            cursor: row-resize;
        }
        .resizer-v:hover { border-bottom: 3px solid var(--selection-blue); }

        /* ボタン */
        button { 
            cursor: pointer; padding: 6px 14px; 
            background: #fff; border: 1px solid #dadce0; 
            border-radius: 4px; font-size: 13px; font-weight: 500;
            transition: background 0.2s;
        }
        button:hover { background: #f1f3f4; border-color: #bdc1c6; }
    </style>
</head>
<body>

<div class="toolbar">
    <button onclick="addRow()">＋ 行を追加</button>
    <button onclick="addCol()">＋ 列を追加</button>
    <button onclick="exportCSV()" style="margin-left: auto; background: #1a73e8; color: white; border: none;">CSV書き出し</button>
</div>

<div class="table-container">
    <table id="spreadsheet">
        <colgroup id="col-group">
            <col style="width: 50px;"> </colgroup>
        <thead>
            <tr id="header-row">
                <th class="row-header"></th>
            </tr>
        </thead>
        <tbody id="table-body">
            </tbody>
    </table>
</div>

<script>
    const tableBody = document.getElementById('table-body');
    const headerRow = document.getElementById('header-row');
    const colGroup = document.getElementById('col-group');
    
    let rowCount = 0;
    let colCount = 0;

    // 列名（A, B, C...）の生成
    function getColName(n) {
        let name = "";
        while (n >= 0) {
            name = String.fromCharCode((n % 26) + 65) + name;
            n = Math.floor(n / 26) - 1;
        }
        return name;
    }

    // 列の追加
    function addCol() {
        const index = colCount;
        
        // 1. col要素の追加（幅制御用）
        const col = document.createElement('col');
        col.style.width = "100px";
        colGroup.appendChild(col);

        // 2. ヘッダーの追加
        const th = document.createElement('th');
        th.innerHTML = `<span>${getColName(index)}</span><div class="resizer-h"></div>`;
        
        // リサイズイベントの登録
        const resizer = th.querySelector('.resizer-h');
        resizer.addEventListener('mousedown', (e) => initResizeCol(e, col));
        
        headerRow.appendChild(th);

        // 3. 既存の各行にセルを追加
        Array.from(tableBody.rows).forEach(row => {
            appendCell(row);
        });

        colCount++;
    }

    // 行の追加
    function addRow() {
        const tr = document.createElement('tr');
        tr.style.height = "28px";

        // 行ヘッダー（番号）
        const th = document.createElement('th');
        th.className = 'row-header';
        th.innerHTML = `<span>${rowCount + 1}</span><div class="resizer-v"></div>`;
        
        // リサイズイベント
        const resizer = th.querySelector('.resizer-v');
        resizer.addEventListener('mousedown', (e) => initResizeRow(e, tr));
        
        tr.appendChild(th);

        // 列の数だけセルを追加
        for (let i = 0; i < colCount; i++) {
            appendCell(tr);
        }

        tableBody.appendChild(tr);
        rowCount++;
    }

    function appendCell(row) {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        td.appendChild(input);
        row.appendChild(td);
    }

    // --- リサイズロジック ---

    function initResizeCol(e, colElement) {
        const startX = e.pageX;
        const startWidth = parseInt(getComputedStyle(colElement).width);
        
        const onMouseMove = (e) => {
            const newWidth = startWidth + (e.pageX - startX);
            colElement.style.width = Math.max(40, newWidth) + 'px';
        };
        
        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            document.body.style.cursor = 'default';
        };

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        document.body.style.cursor = 'col-resize';
    }

    function initResizeRow(e, rowElement) {
        const startY = e.pageY;
        const startHeight = rowElement.offsetHeight;

        const onMouseMove = (e) => {
            const newHeight = startHeight + (e.pageY - startY);
            rowElement.style.height = Math.max(25, newHeight) + 'px';
        };

        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            document.body.style.cursor = 'default';
        };

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        document.body.style.cursor = 'row-resize';
    }

    // --- CSVエクスポート ---
    function exportCSV() {
        let csv = [];
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const rowData = Array.from(row.querySelectorAll('input'))
                                 .map(input => `"${input.value.replace(/"/g, '""')}"`);
            csv.push(rowData.join(","));
        });
        
        const blob = new Blob([csv.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `spreadsheet_${new Date().getTime()}.csv`;
        link.click();
    }

    // 初期化 (15行 x 8列)
    for(let i=0; i<8; i++) addCol();
    for(let i=0; i<15; i++) addRow();

</script>

</body>
</html>
