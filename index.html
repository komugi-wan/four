<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTK-Room Storage Designer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root { --accent: #4ade80; --sub: #f472b6; --bg: #0f172a; --panel: #1e293b; --text: #f1f5f9; }
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: var(--bg); color: var(--text); }
        
        /* ç”»é¢ä¸Šéƒ¨: 3Dãƒ“ãƒ¥ãƒ¼ */
        #view-container { height: 45vh; width: 100%; position: relative; }
        
        /* ç”»é¢ä¸‹éƒ¨: æ“ä½œãƒ‘ãƒãƒ« */
        #ui-panel {
            height: 55vh; width: 100%; background: var(--panel);
            border-top: 3px solid var(--accent); overflow-y: auto;
            border-radius: 24px 24px 0 0; position: relative; z-index: 10;
        }

        .view-controls {
            position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 20;
        }
        .v-btn { background: rgba(0,0,0,0.6); color: white; border: 1px solid var(--accent); padding: 8px 12px; border-radius: 20px; font-size: 12px; }

        .tabs { display: flex; padding: 10px; gap: 5px; sticky; top: 0; background: var(--panel); }
        .tab { flex: 1; padding: 12px; text-align: center; font-size: 14px; background: #334155; border-radius: 12px; cursor: pointer; }
        .tab.active { background: var(--accent); color: #000; font-weight: bold; }

        .section { padding: 15px; display: none; }
        .section.active { display: block; }

        .card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; margin-bottom: 15px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .field { margin-bottom: 10px; }
        label { display: block; font-size: 11px; color: #94a3b8; margin-bottom: 4px; }
        
        input, select { 
            width: 100%; background: #0f172a; border: 1px solid #334155; color: white; 
            padding: 10px; border-radius: 8px; box-sizing: border-box; font-size: 14px;
        }

        .btn-add { background: var(--accent); color: #000; border: none; width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; margin-top: 10px; }
        .btn-sub { background: var(--sub); color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; margin-top: 5px; }
        
        .label-preview { border-left: 4px solid var(--sub); background: #0f172a; padding: 10px; margin-top: 5px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div id="view-container">
    <div class="view-controls">
        <button class="v-btn" onclick="setView('3d')">3Dè¦–ç‚¹</button>
        <button class="v-btn" onclick="setView('2d')">å¹³é¢å›³</button>
    </div>
</div>

<div id="ui-panel">
    <div class="tabs">
        <div class="tab active" onclick="tab(0)">ğŸ  éƒ¨å±‹</div>
        <div class="tab" onclick="tab(1)">ğŸ›‹ï¸ å®¶å…·</div>
        <div class="tab" id="tab-storage" onclick="tab(2)">ğŸ“¦ ä¸­èº«</div>
    </div>

    <div id="sec-0" class="section active">
        <div class="card">
            <label>éƒ¨å±‹ã®ã‚µã‚¤ã‚º (å¹… x å¥¥è¡Œã cm)</label>
            <div class="grid-3">
                <input type="number" id="room-w" value="300">
                <input type="number" id="room-d" value="300">
                <button class="v-btn" onclick="updateRoom()">æ›´æ–°</button>
            </div>
            <div style="margin-top:15px;">
                <label>é–‹å£éƒ¨ï¼ˆçª“ãƒ»æ‰‰ï¼‰ã®è¿½åŠ </label>
                <div class="grid-3">
                    <select id="opening-type">
                        <option value="window">çª“</option>
                        <option value="door">æ‰‰</option>
                    </select>
                    <button class="v-btn" onclick="addOpening()">é…ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <div id="sec-1" class="section">
        <div class="card">
            <label>å®¶å…·ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
            <select id="f-preset" onchange="applyFPreset()" style="margin-bottom:10px;">
                <option value="box">ã‚«ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹</option>
                <option value="shelf">æœ¬æ£š</option>
                <option value="case">ã‚¬ãƒ©ã‚¹ã‚±ãƒ¼ã‚¹</option>
            </select>
            <div class="grid-3">
                <div class="field"><label>å¹…</label><input type="number" id="f-w" value="40"></div>
                <div class="field"><label>é«˜</label><input type="number" id="f-h" value="90"></div>
                <div class="field"><label>å¥¥</label><input type="number" id="f-d" value="30"></div>
            </div>
            <div class="grid-3">
                <div class="field"><label>æ®µæ•°</label><input type="number" id="f-step" value="3"></div>
                <div class="field"><label>è‰²</label><input type="color" id="f-c" value="#e2e8f0"></div>
            </div>
            <button class="btn-add" onclick="spawnFurniture()">å®¶å…·ã‚’éƒ¨å±‹ã«ç½®ã</button>
        </div>
    </div>

    <div id="sec-2" class="section">
        <div id="storage-editor" style="display:none;">
            <div class="card">
                <div id="target-name" style="font-weight:bold; color:var(--accent); margin-bottom:10px;">é¸æŠä¸­ã®å®¶å…·</div>
                <label>åç´ã‚±ãƒ¼ã‚¹ã®è¿½åŠ </label>
                <div class="field">
                    <input type="text" id="i-label" placeholder="ãƒ©ãƒ™ãƒ« (ä¾‹: æ¨ã—ç¼¶ãƒãƒƒã‚¸)">
                </div>
                <div class="grid-3">
                    <div class="field"><label>å¹…</label><input type="number" id="i-w" value="15"></div>
                    <div class="field"><label>é«˜</label><input type="number" id="i-h" value="10"></div>
                    <div class="field"><label>å¥¥</label><input type="number" id="i-d" value="25"></div>
                </div>
                <button class="btn-sub" onclick="addItemToFurniture()">ã“ã®ã‚µã‚¤ã‚ºã‚’ä¸¦ã¹ã‚‹</button>
            </div>
            <div id="item-list"></div>
        </div>
        <div id="storage-msg" style="text-align:center; opacity:0.5; padding:40px;">
            å®¶å…·ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ä¸­èº«ã‚’ç·¨é›†
        </div>
    </div>
</div>

<script>
let scene, camera, renderer, controls, raycaster, mouse;
let roomGroup, furnitureList = [];
let selectedFurniture = null;

init();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0f172a);

    camera = new THREE.PerspectiveCamera(50, window.innerWidth / (window.innerHeight * 0.45), 1, 2000);
    camera.position.set(300, 300, 300);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight * 0.45);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.getElementById('view-container').appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.maxPolarAngle = Math.PI / 2; // åœ°é¢ä»¥ä¸‹é˜²æ­¢

    const light = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(light);
    const dLight = new THREE.DirectionalLight(0xffffff, 0.5);
    dLight.position.set(200, 500, 200);
    scene.add(dLight);

    roomGroup = new THREE.Group();
    scene.add(roomGroup);

    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();

    updateRoom();
    window.addEventListener('resize', onResize);
    renderer.domElement.addEventListener('pointerdown', onClick);
}

function tab(idx) {
    document.querySelectorAll('.section').forEach((s, i) => s.classList.toggle('active', i === idx));
    document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
}

function setView(mode) {
    if(mode === '2d') {
        camera.position.set(0, 500, 0);
        controls.enableRotate = false;
    } else {
        camera.position.set(300, 300, 300);
        controls.enableRotate = true;
    }
}

function updateRoom() {
    roomGroup.clear();
    const w = parseFloat(document.getElementById('room-w').value);
    const d = parseFloat(document.getElementById('room-d').value);
    
    // åºŠ
    const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(w, d),
        new THREE.MeshPhongMaterial({ color: 0x1e293b })
    );
    floor.rotation.x = -Math.PI/2;
    roomGroup.add(floor);

    // å£ã®ç°¡æ˜“ç”Ÿæˆ
    const wallMat = new THREE.MeshPhongMaterial({ color: 0x334155, transparent: true, opacity: 0.5 });
    const walls = [
        { s: [w, 240, 2], p: [0, 120, -d/2] },
        { s: [w, 240, 2], p: [0, 120, d/2] },
        { s: [2, 240, d], p: [-w/2, 120, 0] },
        { s: [2, 240, d], p: [w/2, 120, 0] }
    ];
    walls.forEach(config => {
        const wall = new THREE.Mesh(new THREE.BoxGeometry(...config.s), wallMat);
        wall.position.set(...config.p);
        roomGroup.add(wall);
    });
}

function addOpening() {
    const type = document.getElementById('opening-type').value;
    const color = type === 'window' ? 0xbae6fd : 0x78350f;
    const mesh = new THREE.Mesh(
        new THREE.BoxGeometry(60, type === 'window' ? 60 : 200, 5),
        new THREE.MeshPhongMaterial({ color: color })
    );
    mesh.position.set(0, type === 'window' ? 120 : 100, -parseFloat(document.getElementById('room-d').value)/2);
    roomGroup.add(mesh);
}

function spawnFurniture() {
    const w = parseFloat(document.getElementById('f-w').value);
    const h = parseFloat(document.getElementById('f-h').value);
    const d = parseFloat(document.getElementById('f-d').value);
    const steps = parseInt(document.getElementById('f-step').value);
    const col = document.getElementById('f-c').value;

    const group = new THREE.Group();
    const mat = new THREE.MeshPhongMaterial({ color: col });
    
    // æœ¬ä½“
    const body = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), mat);
    group.add(body);

    // æ®µæ¿ï¼ˆè¦–è¦šçš„ãªã‚¬ã‚¤ãƒ‰ï¼‰
    for(let i=1; i<steps; i++) {
        const shelf = new THREE.Mesh(new THREE.BoxGeometry(w*0.95, 2, d*0.95), new THREE.MeshPhongMaterial({color:0x000000, opacity:0.2, transparent:true}));
        shelf.position.y = -h/2 + (h/steps)*i;
        group.add(shelf);
    }

    group.position.y = h/2;
    group.userData = { type: 'furniture', items: [], h, w, d, steps };
    scene.add(group);
    furnitureList.push(group);
    selectFurniture(group);
    tab(2);
}

function onClick(e) {
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = ( (e.clientX - rect.left) / rect.width ) * 2 - 1;
    mouse.y = -( (e.clientY - rect.top) / rect.height ) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(furnitureList, true);

    if (intersects.length > 0) {
        let obj = intersects[0].object;
        while(obj.parent && obj.userData.type !== 'furniture') obj = obj.parent;
        selectFurniture(obj);
        
        // ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•
        controls.enabled = false;
        const move = (me) => {
            const rectM = renderer.domElement.getBoundingClientRect();
            const mx = ((me.clientX - rectM.left) / rectM.width) * 2 - 1;
            const my = -((me.clientY - rectM.top) / rectM.height) * 2 + 1;
            raycaster.setFromCamera({x:mx, y:my}, camera);
            const hit = new THREE.Vector3();
            raycaster.ray.intersectPlane(new THREE.Plane(new THREE.Vector3(0,1,0), 0), hit);
            obj.position.x = hit.x;
            obj.position.z = hit.z;
        };
        const up = () => {
            window.removeEventListener('pointermove', move);
            controls.enabled = true;
        };
        window.addEventListener('pointermove', move);
        window.addEventListener('pointerup', up, {once:true});
    }
}

function selectFurniture(obj) {
    if(selectedFurniture) selectedFurniture.children[0].material.emissive.setHex(0x000000);
    selectedFurniture = obj;
    selectedFurniture.children[0].material.emissive.setHex(0x222222);
    
    document.getElementById('storage-editor').style.display = 'block';
    document.getElementById('storage-msg').style.display = 'none';
    updateItemList();
}

function addItemToFurniture() {
    if(!selectedFurniture) return;
    const label = document.getElementById('i-label').value || "ã‚°ãƒƒã‚º";
    const iw = parseFloat(document.getElementById('i-w').value);
    const ih = parseFloat(document.getElementById('i-h').value);
    const id = parseFloat(document.getElementById('i-d').value);
    
    const itemGeo = new THREE.BoxGeometry(iw, ih, id);
    const itemMat = new THREE.MeshPhongMaterial({ color: 0xf472b6 });
    const itemMesh = new THREE.Mesh(itemGeo, itemMat);

    // ãƒ©ãƒ™ãƒ«ï¼ˆç°¡æ˜“ï¼‰
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 128; canvas.height = 64;
    ctx.fillStyle = '#f472b6'; ctx.fillRect(0,0,128,64);
    ctx.fillStyle = 'white'; ctx.font = '20px sans-serif';
    ctx.fillText(label, 10, 40);
    const tex = new THREE.CanvasTexture(canvas);
    const labelSprite = new THREE.Mesh(new THREE.PlaneGeometry(iw*0.8, ih*0.5), new THREE.MeshBasicMaterial({map:tex}));
    labelSprite.position.z = id/2 + 0.1;
    itemMesh.add(labelSprite);

    // å®¶å…·å†…ã®æœ€ä¸‹æ®µã«é…ç½®
    itemMesh.position.set(0, -selectedFurniture.userData.h/2 + ih/2 + 2, 0);
    selectedFurniture.add(itemMesh);
    
    selectedFurniture.userData.items.push(label);
    updateItemList();
}

function updateItemList() {
    const container = document.getElementById('item-list');
    container.innerHTML = '<strong>ä¸­èº«ä¸€è¦§</strong>';
    selectedFurniture.userData.items.forEach(name => {
        const div = document.createElement('div');
        div.className = 'label-preview';
        div.innerHTML = `<span>${name}</span><span>Ã—1</span>`;
        container.appendChild(div);
    });
}

function onResize() {
    camera.aspect = window.innerWidth / (window.innerHeight * 0.45);
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight * 0.45);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

function applyFPreset() {
    const p = document.getElementById('f-preset').value;
    if(p==='box'){ setF(40, 90, 30, 3); }
    if(p==='shelf'){ setF(60, 180, 17, 6); }
    if(p==='case'){ setF(80, 160, 40, 4); }
}
function setF(w,h,d,s){
    document.getElementById('f-w').value = w;
    document.getElementById('f-h').value = h;
    document.getElementById('f-d').value = d;
    document.getElementById('f-step').value = s;
}
</script>
</body>
</html>
