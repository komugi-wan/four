<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTK-Storage Sim Pro Custom</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root { --accent: #00d2ff; --sub-accent: #ff007a; --bg: #0b0b14; --panel: #161625; --text: #e0e0e0; --input-bg: #1f1f33; }
        body { margin: 0; overflow: hidden; font-family: 'Hiragino Kaku Gothic ProN', sans-serif; background: var(--bg); color: var(--text); touch-action: none; }
        
        /* 3D Viewport */
        #view-container { height: 40vh; width: 100%; position: relative; background: #000; }
        
        /* UI Panel */
        #ui-panel {
            position: absolute; bottom: 0; width: 100%; height: 60%;
            background: var(--panel); border-top: 2px solid var(--accent);
            overflow-y: auto; box-sizing: border-box; z-index: 100;
            border-radius: 20px 20px 0 0; padding-bottom: 40px;
        }

        .tabs { display: flex; position: sticky; top: 0; background: var(--panel); z-index: 10; padding: 10px; gap: 8px; }
        .tab { flex: 1; padding: 12px 5px; text-align: center; font-size: 13px; cursor: pointer; color: #777; border-radius: 10px; background: rgba(255,255,255,0.05); }
        .tab.active { color: #fff; background: var(--accent); font-weight: bold; }

        .content { padding: 10px 20px; }
        .menu-section { display: none; }
        .menu-section.active { display: block; }
        
        .control-group { background: rgba(255,255,255,0.04); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.08); }
        .group-title { font-size: 14px; font-weight: bold; margin-bottom: 12px; color: var(--accent); display: flex; align-items: center; justify-content: space-between; }
        
        .input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 10px; color: #888; margin-bottom: 4px; }
        
        input, select { 
            background: var(--input-bg); color: #fff; border: 1px solid #333;
            padding: 10px; border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box;
        }
        
        .btn-main { background: var(--accent); color: #000; width: 100%; font-weight: bold; border: none; padding: 15px; border-radius: 10px; font-size: 14px; cursor: pointer; margin-top: 5px; }
        .btn-sub { background: var(--sub-accent); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; }
        .btn-delete { background: #ff4757; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; }

        .item-card { 
            display: flex; align-items: center; padding: 10px; background: rgba(0,0,0,0.3); 
            margin-bottom: 8px; border-radius: 8px; border-left: 4px solid var(--sub-accent);
        }

        .hint { font-size: 11px; color: #666; margin-top: 5px; line-height: 1.4; }
    </style>
</head>
<body>

<div id="view-container"></div>

<div id="ui-panel">
    <div class="tabs">
        <div class="tab active" onclick="showTab('sec-room', this)">ğŸ“ é–“å–ã‚Š</div>
        <div class="tab" onclick="showTab('sec-furniture', this)">ï¼‹ å®¶å…·</div>
        <div id="tab-storage" class="tab" onclick="showTab('sec-storage', this)">ğŸ“¦ åç´å“</div>
    </div>

    <div class="content">
        <div id="sec-room" class="menu-section active">
            <div class="control-group">
                <div class="group-title">éƒ¨å±‹ã®å½¢çŠ¶ (X,Z åº§æ¨™ãƒªã‚¹ãƒˆ)</div>
                <input type="text" id="room-points" value="0,0, 300,0, 300,300, 100,300, 100,450, 0,450" placeholder="0,0, 300,0, ...">
                <div class="hint">â€»(å¹…, å¥¥è¡Œã)ã‚’cmå˜ä½ã§ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã€‚Lå­—å‹ãªã©ã®å¤‰å½¢ã‚‚å¯èƒ½ã€‚</div>
                <div class="input-grid" style="margin-top:10px;">
                    <div class="field"><label>åºŠã®è‰²</label><input type="color" id="floor-color" value="#222222"></div>
                    <div class="field"><label>å£ã®è‰²</label><input type="color" id="wall-color" value="#ffffff"></div>
                    <div class="field"><label>å£é«˜</label><input type="number" id="wall-h" value="240"></div>
                </div>
                <button class="btn-main" onclick="buildRoom()">éƒ¨å±‹ã‚’ç”Ÿæˆãƒ»æ›´æ–°</button>
            </div>
        </div>

        <div id="sec-furniture" class="menu-section">
            <div class="control-group">
                <div class="group-title">å®¶å…·ãƒ—ãƒªã‚»ãƒƒãƒˆ</div>
                <select id="f-preset" onchange="applyPreset()" style="margin-bottom:10px;">
                    <option value="cb3">ã‚«ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹ (3æ®µ)</option>
                    <option value="bookshelf">ã‚¹ãƒªãƒ æœ¬æ£š</option>
                    <option value="display">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚±ãƒ¼ã‚¹</option>
                    <option value="desk">ä½œæ¥­ãƒ‡ã‚¹ã‚¯</option>
                </select>
                <div class="input-grid">
                    <div class="field"><label>å¹…(W)</label><input type="number" id="f-w" value="42"></div>
                    <div class="field"><label>é«˜(H)</label><input type="number" id="f-h" value="88"></div>
                    <div class="field"><label>å¥¥(D)</label><input type="number" id="f-d" value="29"></div>
                    <div class="field"><label>æ®µæ•°</label><input type="number" id="f-shelves" value="3"></div>
                    <div class="field"><label>æ¿åš</label><input type="number" id="f-thick" value="1.5"></div>
                    <div class="field"><label>å®¶å…·è‰²</label><input type="color" id="f-color" value="#d2b48c"></div>
                </div>
                <button class="btn-main" onclick="addFurniture()">å®¶å…·ã‚’é…ç½®</button>
            </div>
        </div>

        <div id="sec-storage" class="menu-section">
            <div id="storage-active-ui" style="display:none;">
                <div class="group-title">
                    <span id="edit-target-name">å®¶å…·ã®ç·¨é›†</span>
                    <button class="btn-delete" onclick="deleteSelected()">å‰Šé™¤</button>
                </div>
                
                <div class="control-group">
                    <div class="group-title" style="color:var(--sub-accent);">åç´ã‚±ãƒ¼ã‚¹ãƒ»ã‚°ãƒƒã‚ºè¿½åŠ </div>
                    <div class="field" style="margin-bottom:10px;">
                        <label>ãƒ©ãƒ™ãƒ« (ä¸­èº«ã®åç§°)</label>
                        <input type="text" id="c-label" placeholder="ä¾‹ï¼šç¼¶ãƒãƒƒã‚¸BOX A">
                    </div>
                    <div class="input-grid">
                        <div class="field"><label>å¹…</label><input type="number" id="c-w" value="18"></div>
                        <div class="field"><label>é«˜</label><input type="number" id="c-h" value="12"></div>
                        <div class="field"><label>å¥¥</label><input type="number" id="c-d" value="25"></div>
                        <div class="field"><label>å·¦ã‚ªãƒ•ã‚»ãƒƒãƒˆ</label><input type="number" id="c-px" value="2"></div>
                        <div class="field"><label>ä¸‹ã‚ªãƒ•ã‚»ãƒƒãƒˆ</label><input type="number" id="c-py" value="2"></div>
                        <div class="field"><label>è‰²</label><input type="color" id="c-color" value="#ff79c6"></div>
                    </div>
                    <button class="btn-sub" onclick="addCase()">ã‚±ãƒ¼ã‚¹ã‚’åç´ã™ã‚‹</button>
                </div>
                
                <div id="case-list-container">
                    <div class="group-title">ã“ã®å®¶å…·ã®ä¸­èº«ä¸€è¦§</div>
                    <div id="case-list"></div>
                </div>
            </div>
            
            <div id="storage-idle-msg" style="text-align:center; padding:30px; color:#555; border:2px dashed #333; border-radius:20px;">
                å®¶å…·ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠã—ã¦ãã ã•ã„
            </div>
        </div>
    </div>
</div>

<script>
    let scene, camera, renderer, controls, raycaster, mouse;
    let floorMesh, wallGroup, selectedObj = null;
    let furnitureList = [];

    init();
    animate();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0b0b14);

        camera = new THREE.PerspectiveCamera(50, window.innerWidth / (window.innerHeight * 0.4), 1, 3000);
        camera.position.set(400, 400, 400);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight * 0.4);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('view-container').appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.maxPolarAngle = Math.PI / 2.1; // åœ°é¢ã‚ˆã‚Šä¸‹ã«è¡Œã‹ãªã„

        const ambLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.4);
        dirLight.position.set(100, 500, 200);
        scene.add(dirLight);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        wallGroup = new THREE.Group();
        scene.add(wallGroup);

        buildRoom();

        renderer.domElement.addEventListener('pointerdown', onPointerDown, false);
        window.addEventListener('resize', onResize);
    }

    function showTab(id, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.menu-section').forEach(s => s.classList.remove('active'));
        el.classList.add('active');
        document.getElementById(id).classList.add('active');
    }

    function buildRoom() {
        if (floorMesh) scene.remove(floorMesh);
        wallGroup.clear();

        const pointsRaw = document.getElementById('room-points').value.split(',').map(n => parseFloat(n.trim()));
        const wallH = parseFloat(document.getElementById('wall-h').value);
        const floorCol = document.getElementById('floor-color').value;
        const wallCol = document.getElementById('wall-color').value;

        const pts = [];
        for (let i = 0; i < pointsRaw.length; i += 2) {
            pts.push(new THREE.Vector2(pointsRaw[i], pointsRaw[i+1]));
        }

        const shape = new THREE.Shape(pts);
        const floorGeo = new THREE.ShapeGeometry(shape);
        const floorMat = new THREE.MeshPhongMaterial({ color: floorCol, side: THREE.DoubleSide });
        floorMesh = new THREE.Mesh(floorGeo, floorMat);
        floorMesh.rotation.x = -Math.PI / 2;
        scene.add(floorMesh);

        // å£ã®ç”Ÿæˆ
        for (let i = 0; i < pts.length; i++) {
            const p1 = pts[i];
            const p2 = pts[(i + 1) % pts.length];
            const dist = p1.distanceTo(p2);
            const wallGeo = new THREE.BoxGeometry(dist, wallH, 4);
            const wallMat = new THREE.MeshPhongMaterial({ color: wallCol, transparent: true, opacity: 0.8 });
            const wall = new THREE.Mesh(wallGeo, wallMat);

            const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);
            wall.position.set((p1.x + p2.x)/2, wallH/2, (p1.y + p2.y)/2);
            wall.rotation.y = -angle;
            wallGroup.add(wall);
        }
    }

    function applyPreset() {
        const p = document.getElementById('f-preset').value;
        const w = document.getElementById('f-w'), h = document.getElementById('f-h'), d = document.getElementById('f-d'), s = document.getElementById('f-shelves');
        if(p === 'cb3') { w.value = 42; h.value = 88; d.value = 29; s.value = 3; }
        else if(p === 'bookshelf') { w.value = 60; h.value = 180; d.value = 17; s.value = 6; }
        else if(p === 'display') { w.value = 80; h.value = 160; d.value = 40; s.value = 4; }
        else if(p === 'desk') { w.value = 120; h.value = 72; d.value = 60; s.value = 1; }
    }

    function addFurniture() {
        const w = parseFloat(document.getElementById('f-w').value);
        const h = parseFloat(document.getElementById('f-h').value);
        const d = parseFloat(document.getElementById('f-d').value);
        const shelves = parseInt(document.getElementById('f-shelves').value);
        const thick = parseFloat(document.getElementById('f-thick').value);
        const fCol = document.getElementById('f-color').value;

        const group = new THREE.Group();
        const mat = new THREE.MeshPhongMaterial({ color: fCol });
        
        // æ§‹é€ ä½“ä½œæˆ (å¤–æ )
        const parts = [
            {s: [w, h, 2], p: [0, 0, -d/2]}, // èƒŒæ¿
            {s: [thick, h, d], p: [-w/2+thick/2, 0, 0]}, // å·¦
            {s: [thick, h, d], p: [w/2-thick/2, 0, 0]}, // å³
            {s: [w, thick, d], p: [0, h/2-thick/2, 0]}, // å¤©
            {s: [w, thick, d], p: [0, -h/2+thick/2, 0]} // åº•
        ];

        parts.forEach(data => {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(...data.s), mat);
            mesh.position.set(...data.p);
            group.add(mesh);
        });

        // æ£šæ¿
        if (shelves > 1) {
            const shelfGap = (h - (thick * (shelves + 1))) / shelves;
            for (let i = 1; i < shelves; i++) {
                const sMesh = new THREE.Mesh(new THREE.BoxGeometry(w - thick*2, thick, d - 2), mat);
                sMesh.position.y = -h/2 + thick + (shelfGap + thick) * i - (thick/2);
                group.add(sMesh);
            }
        }

        group.position.set(50, h/2, 50);
        group.userData = { type: 'furniture', size: {w, h, d, thick}, items: [] };
        
        scene.add(group);
        furnitureList.push(group);
        selectObject(group);
        showTab('sec-storage', document.getElementById('tab-storage'));
    }

    function addCase() {
        if (!selectedObj) return;
        const label = document.getElementById('c-label').value || "æœªå‘½å";
        const cw = parseFloat(document.getElementById('c-w').value);
        const ch = parseFloat(document.getElementById('c-h').value);
        const cd = parseFloat(document.getElementById('c-d').value);
        const px = parseFloat(document.getElementById('c-px').value);
        const py = parseFloat(document.getElementById('c-py').value);
        const col = document.getElementById('c-color').value;

        const f = selectedObj.userData.size;
        const boxGeo = new THREE.BoxGeometry(cw, ch, cd);
        const boxMat = new THREE.MeshPhongMaterial({ color: col });
        const box = new THREE.Mesh(boxGeo, boxMat);
        
        // é…ç½®è¨ˆç®—
        box.position.set(
            -f.w/2 + f.thick + cw/2 + px,
            -f.h/2 + f.thick + ch/2 + py,
            -f.d/2 + cd/2 + 2
        );

        // ãƒ©ãƒ™ãƒ«ç”Ÿæˆ (Canvasãƒ†ã‚¯ã‚¹ãƒãƒ£)
        const canvas = document.createElement('canvas');
        canvas.width = 256; canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = col; ctx.fillRect(0,0,256,64);
        ctx.fillStyle = '#fff'; ctx.font = 'bold 32px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText(label, 128, 42);
        
        const tex = new THREE.CanvasTexture(canvas);
        const labelMat = new THREE.MeshBasicMaterial({ map: tex, transparent: true });
        const labelMesh = new THREE.Mesh(new THREE.PlaneGeometry(cw*0.8, cw*0.2), labelMat);
        labelMesh.position.z = cd/2 + 0.1;
        box.add(labelMesh);

        selectedObj.add(box);
        selectedObj.userData.items.push({ label, color: col });
        updateCaseListUI();
    }

    function onPointerDown(e) {
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = (e.clientX / rect.width) * 2 - 1;
        mouse.y = -(e.clientY / rect.height) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(furnitureList, true);

        if (intersects.length > 0) {
            let obj = intersects[0].object;
            while(obj.parent && obj.userData.type !== 'furniture') obj = obj.parent;
            selectObject(obj);

            // ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ãƒ­ã‚¸ãƒƒã‚¯
            const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
            const onMove = (me) => {
                const moveRect = renderer.domElement.getBoundingClientRect();
                const mx = (me.clientX / moveRect.width) * 2 - 1;
                const my = -(me.clientY / moveRect.height) * 2 + 1;
                raycaster.setFromCamera({x:mx, y:my}, camera);
                const hit = new THREE.Vector3();
                if (raycaster.ray.intersectPlane(plane, hit)) {
                    obj.position.x = Math.round(hit.x / 5) * 5; 
                    obj.position.z = Math.round(hit.z / 5) * 5;
                }
            };
            const onUp = () => {
                window.removeEventListener('pointermove', onMove);
                controls.enabled = true;
            };
            controls.enabled = false;
            window.addEventListener('pointermove', onMove);
            window.addEventListener('pointerup', onUp, {once:true});
        }
    }

    function selectObject(obj) {
        if (selectedObj) {
            selectedObj.children.forEach(c => { if(c.material && c.material.emissive) c.material.emissive.setHex(0x000000); });
        }
        selectedObj = obj;
        selectedObj.children.forEach(c => { if(c.material && c.material.emissive) c.material.emissive.setHex(0x333333); });

        document.getElementById('storage-active-ui').style.display = 'block';
        document.getElementById('storage-idle-msg').style.display = 'none';
        updateCaseListUI();
    }

    function updateCaseListUI() {
        const list = document.getElementById('case-list');
        list.innerHTML = '';
        if(!selectedObj) return;
        selectedObj.userData.items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item-card';
            div.innerHTML = `<span style="flex:1;">${item.label}</span><div style="width:20px;height:20px;background:${item.color};border-radius:3px;"></div>`;
            list.appendChild(div);
        });
    }

    function deleteSelected() {
        if (!selectedObj || !confirm("ã“ã®å®¶å…·ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        scene.remove(selectedObj);
        furnitureList = furnitureList.filter(f => f !== selectedObj);
        selectedObj = null;
        document.getElementById('storage-active-ui').style.display = 'none';
        document.getElementById('storage-idle-msg').style.display = 'block';
    }

    function onResize() {
        camera.aspect = window.innerWidth / (window.innerHeight * 0.4);
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight * 0.4);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();

        // å£ã®èƒŒé¢ã‚«ãƒªãƒ³ã‚°é¢¨å‡¦ç†ï¼ˆã‚«ãƒ¡ãƒ©ä½ç½®ã§è¦‹ãˆæ–¹ã‚’å¤‰ãˆã‚‹ï¼‰
        wallGroup.children.forEach(wall => {
            const wallPos = new THREE.Vector3();
            wall.getWorldPosition(wallPos);
            const camDist = camera.position.distanceTo(wallPos);
            
            const wallVec = new THREE.Vector3();
            wall.getWorldDirection(wallVec);
            const camVec = new THREE.Vector3();
            camera.getWorldDirection(camVec);
            
            // æ‰‹å‰ã®å£ã‚’é€æ˜ã«ã™ã‚‹
            wall.material.opacity = wallVec.dot(camVec) > 0.2 ? 0.1 : 0.9;
        });

        renderer.render(scene, camera);
    }
</script>
</body>
</html>
