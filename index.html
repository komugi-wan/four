<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Grid Memo App</title>
<style>
:root{
  --cell-width: 15em;
  --cell-min-height: 1.6em;
  --font-size:16px;
  --header-height:56px;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{
  margin:0;
  padding:0;
  height:100%;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  font-size:var(--font-size);
  overflow:hidden;
  background:#fafafa;
}

/* ===== Header ===== */
header{
  position:fixed;
  top:0;
  left:0;
  right:0;
  height:var(--header-height);
  background:#ffffff;
  border-bottom:1px solid #ddd;
  display:flex;
  align-items:center;
  padding:6px;
  z-index:1000;
}

header button, header select, header input{
  margin-right:6px;
  font-size:14px;
}

header input{
  flex:1;
}

/* ===== Grid Area ===== */
#grid-wrapper{
  position:absolute;
  top:var(--header-height);
  bottom:0;
  left:0;
  right:0;
  overflow:auto;
  touch-action:none;
  background:#fff;
}

#grid-container{
  transform-origin:0 0;
}

table{
  border-collapse:collapse;
}

th, td{
  border:1px solid #ccc;
  padding:4px;
  min-height:var(--cell-min-height);
  vertical-align:top;
  font-size:var(--font-size);
}

td{
  width:var(--cell-width);
  max-height:6em;
  overflow:hidden;
  word-break:break-word;
}

th{
  background:#f0f0f0;
  text-align:center;
  font-weight:bold;
}

/* Sticky */
thead th{
  position:sticky;
  top:0;
  z-index:10;
}

tbody th{
  position:sticky;
  left:0;
  z-index:5;
}

thead th:first-child{
  left:0;
  z-index:15;
}

/* ===== Modal Editor ===== */
#editor-overlay{
  position:fixed;
  left:0;
  right:0;
  bottom:-100%;
  height:100%;
  background:#fff;
  transition:bottom 0.3s ease;
  z-index:2000;
  display:flex;
  flex-direction:column;
}

#editor-overlay.active{
  bottom:0;
}

#editor-header{
  padding:10px;
  border-bottom:1px solid #ccc;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

#editor-text{
  flex:1;
  padding:10px;
  font-size:16px;
  border:none;
  outline:none;
  resize:none;
}

#char-count{
  font-size:12px;
  color:#666;
}

button{
  padding:6px 10px;
}

</style>
</head>
<body>

<header>
  <button id="addSheet">＋</button>
  <button id="deleteSheet">－</button>
  <select id="sheetSelect"></select>
  <input id="sheetName" placeholder="シート名">
</header>

<div id="grid-wrapper">
  <div id="grid-container"></div>
</div>

<div id="editor-overlay">
  <div id="editor-header">
    <span id="cell-label"></span>
    <div>
      <span id="char-count">0文字</span>
      <button id="saveCell">保存</button>
    </div>
  </div>
  <textarea id="editor-text"></textarea>
</div>

<script>
const ROWS = 50;
const COLS = 12;
const COL_LABELS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".slice(0,COLS).split("");

let db;
let currentSheetId = null;
let scale = 1;
let startDist = null;
let startScale = 1;
let editingCell = null;

/* ===== IndexedDB ===== */
const request = indexedDB.open("GridMemoDB",1);
request.onupgradeneeded = e=>{
  db = e.target.result;
  const store = db.createObjectStore("sheets",{keyPath:"id",autoIncrement:true});
};
request.onsuccess = e=>{
  db = e.target.result;
  init();
};

function getAllSheets(){
  return new Promise(resolve=>{
    const tx=db.transaction("sheets","readonly");
    const store=tx.objectStore("sheets");
    const req=store.getAll();
    req.onsuccess=()=>resolve(req.result);
  });
}

function saveSheet(sheet){
  const tx=db.transaction("sheets","readwrite");
  tx.objectStore("sheets").put(sheet);
}

function deleteSheetDB(id){
  const tx=db.transaction("sheets","readwrite");
  tx.objectStore("sheets").delete(id);
}

/* ===== Init ===== */
async function init(){
  let sheets = await getAllSheets();
  if(sheets.length===0){
    const defaultSheet={name:"Sheet1",cells:{}};
    saveSheet(defaultSheet);
    setTimeout(init,100);
    return;
  }
  populateSheetSelect(sheets);
  loadSheet(sheets[0].id);
}

function populateSheetSelect(sheets){
  const select=document.getElementById("sheetSelect");
  select.innerHTML="";
  sheets.forEach(sheet=>{
    const opt=document.createElement("option");
    opt.value=sheet.id;
    opt.textContent=sheet.name;
    select.appendChild(opt);
  });
}

/* ===== Load Sheet ===== */
async function loadSheet(id){
  currentSheetId = Number(id);
  const tx=db.transaction("sheets","readonly");
  const sheet=await new Promise(resolve=>{
    const req=tx.objectStore("sheets").get(currentSheetId);
    req.onsuccess=()=>resolve(req.result);
  });
  document.getElementById("sheetName").value=sheet.name;
  renderGrid(sheet.cells||{});
}

function renderGrid(cells){
  const container=document.getElementById("grid-container");
  container.innerHTML="";
  const table=document.createElement("table");

  const thead=document.createElement("thead");
  const tr=document.createElement("tr");
  const corner=document.createElement("th");
  tr.appendChild(corner);
  COL_LABELS.forEach(label=>{
    const th=document.createElement("th");
    th.textContent=label;
    tr.appendChild(th);
  });
  thead.appendChild(tr);
  table.appendChild(thead);

  const tbody=document.createElement("tbody");
  for(let r=1;r<=ROWS;r++){
    const row=document.createElement("tr");
    const th=document.createElement("th");
    th.textContent=r;
    row.appendChild(th);
    for(let c=0;c<COLS;c++){
      const key=r+"-"+c;
      const td=document.createElement("td");
      td.dataset.key=key;
      td.textContent=cells[key]||"";
      td.onclick=()=>openEditor(r,c,cells[key]||"");
      row.appendChild(td);
    }
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
  container.appendChild(table);
}

/* ===== Editor ===== */
function openEditor(r,c,value){
  editingCell={r,c};
  document.getElementById("editor-text").value=value;
  document.getElementById("char-count").textContent=value.length+"文字";
  document.getElementById("cell-label").textContent=COL_LABELS[c]+r;
  document.getElementById("editor-overlay").classList.add("active");
}

document.getElementById("editor-text").addEventListener("input",e=>{
  document.getElementById("char-count").textContent=e.target.value.length+"文字";
});

document.getElementById("saveCell").onclick=async ()=>{
  const text=document.getElementById("editor-text").value;
  const tx=db.transaction("sheets","readwrite");
  const store=tx.objectStore("sheets");
  const sheet=await new Promise(resolve=>{
    const req=store.get(currentSheetId);
    req.onsuccess=()=>resolve(req.result);
  });
  const key=editingCell.r+"-"+editingCell.c;
  sheet.cells=sheet.cells||{};
  sheet.cells[key]=text;
  store.put(sheet);
  document.getElementById("editor-overlay").classList.remove("active");
  loadSheet(currentSheetId);
};

/* ===== Sheet Controls ===== */
document.getElementById("sheetSelect").onchange=e=>{
  loadSheet(e.target.value);
};

document.getElementById("sheetName").onchange=async e=>{
  const tx=db.transaction("sheets","readwrite");
  const store=tx.objectStore("sheets");
  const sheet=await new Promise(resolve=>{
    const req=store.get(currentSheetId);
    req.onsuccess=()=>resolve(req.result);
  });
  sheet.name=e.target.value;
  store.put(sheet);
  init();
};

document.getElementById("addSheet").onclick=()=>{
  saveSheet({name:"NewSheet",cells:{}});
  setTimeout(init,100);
};

document.getElementById("deleteSheet").onclick=()=>{
  if(confirm("削除しますか？")){
    deleteSheetDB(currentSheetId);
    setTimeout(init,100);
  }
};

/* ===== Pinch Zoom ===== */
const wrapper=document.getElementById("grid-wrapper");
const container=document.getElementById("grid-container");

wrapper.addEventListener("touchstart",e=>{
  if(e.touches.length===2){
    startDist=getDist(e);
    startScale=scale;
  }
});

wrapper.addEventListener("touchmove",e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const dist=getDist(e);
    scale=startScale*(dist/startDist);
    scale=Math.max(0.4,Math.min(scale,2));
    container.style.transform=`scale(${scale})`;
  }
},{passive:false});

function getDist(e){
  const dx=e.touches[0].clientX-e.touches[1].clientX;
  const dy=e.touches[0].clientY-e.touches[1].clientY;
  return Math.sqrt(dx*dx+dy*dy);
}

</script>
</body>
</html>
