<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Grid Memo</title>
<style>
:root{
  --pink:#d8a7b1;
  --pink-light:#f3e6ea;
  --border:#e5d6da;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
  background:#faf7f8;
  color:#333;
  touch-action:manipulation;
}
header{
  position:fixed;
  top:0;left:0;right:0;
  height:56px;
  background:var(--pink);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 12px;
  color:#fff;
  z-index:1000;
}
header input{
  border:none;
  background:rgba(255,255,255,0.2);
  color:#fff;
  padding:6px 8px;
  border-radius:6px;
  width:120px;
}
header button{
  border:none;
  background:#fff;
  color:var(--pink);
  padding:6px 10px;
  border-radius:6px;
  font-size:14px;
}
#container{
  position:absolute;
  top:56px;bottom:0;left:0;right:0;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}
table{
  border-collapse:collapse;
  background:#fff;
}
th,td{
  border:1px solid var(--border);
  font-size:16pt;
  min-width:15ch;
  max-width:15ch;
  padding:4px;
  vertical-align:top;
}
td{
  max-height:calc(1.6em * 100);
  overflow:hidden;
  word-break:break-word;
}
th{
  background:var(--pink-light);
  position:sticky;
  z-index:2;
}
thead th{
  top:0;
  z-index:3;
}
tbody th{
  left:0;
  z-index:3;
}
thead th:first-child{
  left:0;
  z-index:4;
}
#gridWrapper{
  transform-origin:0 0;
}
#editorOverlay{
  position:fixed;
  left:0;right:0;bottom:-100%;
  height:100%;
  background:#fff;
  display:flex;
  flex-direction:column;
  transition:bottom 0.3s ease;
  z-index:2000;
}
#editorOverlay.active{bottom:0;}
#editorOverlay textarea{
  flex:1;
  border:none;
  padding:16px;
  font-size:16pt;
  outline:none;
}
#editorOverlay .footer{
  padding:12px;
  border-top:1px solid #ddd;
  display:flex;
  justify-content:space-between;
}
</style>
</head>
<body>

<header>
  <div>
    <button id="addSheet">＋</button>
    <button id="deleteSheet">－</button>
  </div>
  <input id="sheetName" placeholder="シート名">
</header>

<div id="container">
  <div id="gridWrapper"></div>
</div>

<div id="editorOverlay">
  <textarea id="fullEditor"></textarea>
  <div class="footer">
    <span id="charCount">0文字</span>
    <button id="closeEditor">閉じる</button>
  </div>
</div>

<script>
/* ===============================
   IndexedDB 設定
================================ */
const DB_NAME="GridMemoDB";
const STORE="sheets";
let db;

function initDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=e=>{
      db=e.target.result;
      db.createObjectStore(STORE,{keyPath:"id",autoIncrement:true});
    };
    req.onsuccess=e=>{db=e.target.result;resolve();};
    req.onerror=reject;
  });
}
function saveSheet(sheet){
  const tx=db.transaction(STORE,"readwrite");
  tx.objectStore(STORE).put(sheet);
}
function deleteSheetDB(id){
  const tx=db.transaction(STORE,"readwrite");
  tx.objectStore(STORE).delete(id);
}
function getAllSheets(){
  return new Promise(resolve=>{
    const tx=db.transaction(STORE,"readonly");
    const req=tx.objectStore(STORE).getAll();
    req.onsuccess=()=>resolve(req.result);
  });
}

/* ===============================
   シート管理
================================ */
let sheets=[];
let currentSheet=null;

async function loadSheets(){
  sheets=await getAllSheets();
  if(sheets.length===0){
    const empty=createEmptySheet("Sheet1");
    saveSheet(empty);
    sheets=[empty];
  }
  selectSheet(sheets[0].id);
}
function createEmptySheet(name){
  return {
    id:Date.now(),
    name,
    cells:Array.from({length:50},()=>Array(12).fill(""))
  };
}
function selectSheet(id){
  currentSheet=sheets.find(s=>s.id===id);
  render();
  document.getElementById("sheetName").value=currentSheet.name;
}
document.getElementById("addSheet").onclick=()=>{
  const newSheet=createEmptySheet("NewSheet");
  sheets.push(newSheet);
  saveSheet(newSheet);
  selectSheet(newSheet.id);
};
document.getElementById("deleteSheet").onclick=()=>{
  if(!currentSheet) return;
  deleteSheetDB(currentSheet.id);
  sheets=sheets.filter(s=>s.id!==currentSheet.id);
  if(sheets.length===0){
    const s=createEmptySheet("Sheet1");
    sheets=[s];
    saveSheet(s);
  }
  selectSheet(sheets[0].id);
};
document.getElementById("sheetName").oninput=e=>{
  currentSheet.name=e.target.value;
  saveSheet(currentSheet);
};

/* ===============================
   グリッド描画
================================ */
function render(){
  const wrapper=document.getElementById("gridWrapper");
  wrapper.innerHTML="";
  const table=document.createElement("table");
  const thead=document.createElement("thead");
  const tr=document.createElement("tr");
  const corner=document.createElement("th");
  tr.appendChild(corner);
  for(let c=0;c<12;c++){
    const th=document.createElement("th");
    th.textContent=String.fromCharCode(65+c);
    tr.appendChild(th);
  }
  thead.appendChild(tr);
  table.appendChild(thead);

  const tbody=document.createElement("tbody");
  for(let r=0;r<50;r++){
    const tr=document.createElement("tr");
    const th=document.createElement("th");
    th.textContent=r+1;
    tr.appendChild(th);
    for(let c=0;c<12;c++){
      const td=document.createElement("td");
      td.textContent=currentSheet.cells[r][c];
      td.onclick=()=>openEditor(r,c);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  wrapper.appendChild(table);
}

/* ===============================
   長文エディタ
================================ */
let editPos=null;
function openEditor(r,c){
  editPos={r,c};
  const overlay=document.getElementById("editorOverlay");
  const textarea=document.getElementById("fullEditor");
  textarea.value=currentSheet.cells[r][c];
  document.getElementById("charCount").textContent=textarea.value.length+"文字";
  overlay.classList.add("active");
  setTimeout(()=>textarea.focus(),100);
}
document.getElementById("fullEditor").oninput=e=>{
  document.getElementById("charCount").textContent=e.target.value.length+"文字";
};
document.getElementById("closeEditor").onclick=()=>{
  const overlay=document.getElementById("editorOverlay");
  const textarea=document.getElementById("fullEditor");
  if(editPos){
    currentSheet.cells[editPos.r][editPos.c]=textarea.value;
    saveSheet(currentSheet);
    render();
  }
  overlay.classList.remove("active");
};

/* ===============================
   ピンチズーム
================================ */
let scale=1;
let startDist=0;
let startScale=1;
const wrapper=document.getElementById("gridWrapper");

function getDistance(t1,t2){
  return Math.hypot(t2.clientX-t1.clientX,t2.clientY-t1.clientY);
}
wrapper.addEventListener("touchstart",e=>{
  if(e.touches.length===2){
    startDist=getDistance(e.touches[0],e.touches[1]);
    startScale=scale;
  }
},{passive:false});

wrapper.addEventListener("touchmove",e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const dist=getDistance(e.touches[0],e.touches[1]);
    scale=startScale*(dist/startDist);
    scale=Math.min(Math.max(scale,0.4),3);
    wrapper.style.transform=`scale(${scale})`;
  }
},{passive:false});

/* ===============================
   初期化
================================ */
initDB().then(loadSheets);
</script>

</body>
</html>
