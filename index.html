<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTAKU-ROOM Manager Pro v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root { --accent: #ff4757; --bg: #1a1a2e; --panel: rgba(26, 26, 46, 0.98); }
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: var(--bg); color: white; touch-action: none; }
        canvas { display: block; }
        
        /* UI Layout */
        #ui-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40%;
            background: var(--panel); border-top: 2px solid var(--accent);
            overflow-y: auto; padding: 12px; box-sizing: border-box; z-index: 100;
            display: flex; flex-direction: column; transition: 0.3s;
        }
        #ui-panel.minimized { height: 40px; overflow: hidden; }

        .tabs { display: flex; gap: 5px; margin-bottom: 10px; flex-shrink: 0; overflow-x: auto; }
        .tab { padding: 8px 12px; cursor: pointer; font-size: 12px; white-space: nowrap; background: #16213e; border-radius: 4px; opacity: 0.6; }
        .tab.active { opacity: 1; background: var(--accent); font-weight: bold; }

        .menu-section { display: none; }
        .menu-section.active { display: block; }
        
        .input-row { display: flex; align-items: center; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        label { font-size: 11px; color: #aaa; min-width: 50px; }
        input, select, button { 
            background: #0f3460; color: white; border: 1px solid #16213e;
            padding: 8px; border-radius: 4px; font-size: 12px;
        }
        input[type="number"] { width: 50px; }
        button { cursor: pointer; background: #533483; border: none; flex-grow: 1; }
        .btn-add { background: var(--accent); font-weight: bold; }

        #overlay { position: absolute; top: 10px; left: 10px; pointer-events: none; font-size: 10px; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 4px; }
        .shelf-item { border: 1px solid #444; padding: 5px; margin-top: 5px; border-radius: 4px; font-size: 11px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div id="overlay">
    ğŸ“ éƒ¨å±‹: é ‚ç‚¹ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›<br>
    ğŸ–±ï¸ å®¶å…·ã‚’ã‚¿ãƒƒãƒ—ã§é¸æŠ / ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•<br>
    ğŸ“± äºŒæœ¬æŒ‡ã§ã‚ºãƒ¼ãƒ ãƒ»å›è»¢
</div>

<div id="ui-panel">
    <div class="tabs">
        <div class="tab active" data-target="sec-room">1. éƒ¨å±‹ãƒ»å£</div>
        <div class="tab" data-target="sec-furniture">2. å®¶å…·è¿½åŠ </div>
        <div class="tab" data-target="sec-storage">3. åç´ç®¡ç†</div>
    </div>

    <div id="sec-room" class="menu-section active">
        <div class="input-row">
            <label>åºŠé ‚ç‚¹:</label>
            <input type="text" id="room-points" value="0,0, 400,0, 400,300, 200,300, 200,500, 0,500" style="flex-grow: 1;">
        </div>
        <div class="input-row">
            <label>å£ã®é«˜ã•:</label> <input type="number" id="wall-h" value="240">
            <label>è‰²:</label> <input type="color" id="floor-color" value="#2d3436">
            <button onclick="buildRoom()">éƒ¨å±‹ã‚’å†æ§‹ç¯‰</button>
        </div>
    </div>

    <div id="sec-furniture" class="menu-section">
        <div class="input-row">
            <label>ã‚¿ã‚¤ãƒ—:</label>
            <select id="f-preset" onchange="applyPreset()">
                <option value="custom">ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ã‚º</option>
                <option value="cb3">ã‚«ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹3æ®µ</option>
                <option value="bookshelf">å¤§å‹æœ¬æ£š</option>
            </select>
        </div>
        <div class="input-row">
            W:<input type="number" id="f-w" value="60"> 
            H:<input type="number" id="f-h" value="90"> 
            D:<input type="number" id="f-d" value="30">
            <input type="color" id="f-color" value="#e17055">
            <button onclick="addFurniture()" class="btn-add">é…ç½®</button>
        </div>
    </div>

    <div id="sec-storage" class="menu-section">
        <div id="storage-active-ui" style="display:none;">
            <p id="edit-target-name" style="margin:0 0 10px; font-size:12px; color:var(--accent);">å®¶å…·ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            <div class="input-row">
                <input type="text" id="c-label" placeholder="ãƒ©ãƒ™ãƒ«(ä¾‹: æ¨ã—ç¼¶ãƒãƒƒã‚¸)" style="flex-grow:1;">
            </div>
            <div class="input-row">
                W:<input type="number" id="c-w" value="20"> 
                H:<input type="number" id="c-h" value="15"> 
                D:<input type="number" id="c-d" value="20">
                <input type="color" id="c-color" value="#00b894">
                <button onclick="addCase()" class="btn-add">ã‚±ãƒ¼ã‚¹æŠ•å…¥</button>
            </div>
            <button onclick="deleteSelected()" style="background:#d63031; margin-top:5px;">ã“ã®å®¶å…·ã‚’å‰Šé™¤</button>
            <div id="case-list"></div>
        </div>
        <p id="storage-idle-msg">3Dç”»é¢ä¸Šã®å®¶å…·ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç·¨é›†é–‹å§‹</p>
    </div>
</div>

<script>
    let scene, camera, renderer, controls, raycaster, mouse;
    let floorMesh, wallGroup, selectedObj = null;
    const furnitureList = [];

    init();
    animate();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0f0f1a);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / (window.innerHeight * 0.6), 1, 5000);
        camera.position.set(500, 600, 500);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const ambLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
        dirLight.position.set(200, 1000, 500);
        scene.add(dirLight);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        wallGroup = new THREE.Group();
        scene.add(wallGroup);

        buildRoom();

        // Events
        window.addEventListener('mousedown', onPointerDown);
        window.addEventListener('touchstart', (e) => onPointerDown(e.touches[0]));
        window.addEventListener('resize', onResize);

        // Tab System
        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.tab, .menu-section').forEach(el => el.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.target).classList.add('active');
            };
        });
    }

    // --- éƒ¨å±‹ãƒ»å£ã®ç”Ÿæˆ ---
    function buildRoom() {
        if (floorMesh) scene.remove(floorMesh);
        wallGroup.clear();

        const pointsRaw = document.getElementById('room-points').value.split(',');
        const wallH = parseFloat(document.getElementById('wall-h').value);
        const color = document.getElementById('floor-color').value;

        const shape = new THREE.Shape();
        const pts = [];
        for (let i = 0; i < pointsRaw.length; i += 2) {
            const x = parseFloat(pointsRaw[i]);
            const y = parseFloat(pointsRaw[i + 1]);
            pts.push(new THREE.Vector2(x, y));
            if (i === 0) shape.moveTo(x, y); else shape.lineTo(x, y);
        }
        shape.lineTo(pts[0].x, pts[0].y);

        // åºŠ
        const floorGeo = new THREE.ShapeGeometry(shape);
        const floorMat = new THREE.MeshPhongMaterial({ color: color, side: THREE.DoubleSide });
        floorMesh = new THREE.Mesh(floorGeo, floorMat);
        floorMesh.rotation.x = -Math.PI / 2;
        scene.add(floorMesh);

        // å£ã®ç”Ÿæˆ
        for (let i = 0; i < pts.length; i++) {
            const p1 = pts[i];
            const p2 = pts[(i + 1) % pts.length];
            const dist = p1.distanceTo(p2);
            const wallGeo = new THREE.PlaneGeometry(dist, wallH);
            const wallMat = new THREE.MeshPhongMaterial({ color: 0x34495e, side: THREE.DoubleSide, transparent: true, opacity: 0.5 });
            const wall = new THREE.Mesh(wallGeo, wallMat);

            const midX = (p1.x + p2.x) / 2;
            const midY = (p1.y + p2.y) / 2;
            const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x);

            wall.position.set(midX, wallH / 2, midY);
            wall.rotation.y = -angle;
            wallGroup.add(wall);
        }
    }

    // --- å®¶å…·è¿½åŠ  ---
    function applyPreset() {
        const p = document.getElementById('f-preset').value;
        const w = document.getElementById('f-w'), h = document.getElementById('f-h'), d = document.getElementById('f-d');
        if(p === 'cb3') { w.value = 42; h.value = 88; d.value = 29; }
        else if(p === 'bookshelf') { w.value = 90; h.value = 180; d.value = 30; }
    }

    function addFurniture() {
        const w = parseFloat(document.getElementById('f-w').value);
        const h = parseFloat(document.getElementById('f-h').value);
        const d = parseFloat(document.getElementById('f-d').value);
        const col = document.getElementById('f-color').value;

        const geo = new THREE.BoxGeometry(w, h, d);
        const mat = new THREE.MeshPhongMaterial({ color: col, transparent: true, opacity: 0.8 });
        const mesh = new THREE.Mesh(geo, mat);
        
        mesh.position.set(w/2, h/2, d/2);
        mesh.userData = { type: 'furniture', cases: [] };

        const edges = new THREE.LineSegments(new THREE.EdgesGeometry(geo), new THREE.LineBasicMaterial({ color: 0xffffff }));
        mesh.add(edges);

        scene.add(mesh);
        furnitureList.push(mesh);
        selectObject(mesh);
    }

    // --- åç´ã‚±ãƒ¼ã‚¹ç®¡ç† ---
    function addCase() {
        if (!selectedObj) return;
        const labelText = document.getElementById('c-label').value || "NO NAME";
        const cw = parseFloat(document.getElementById('c-w').value);
        const ch = parseFloat(document.getElementById('c-h').value);
        const cd = parseFloat(document.getElementById('c-d').value);
        const col = document.getElementById('c-color').value;

        const geo = new THREE.BoxGeometry(cw, ch, cd);
        const mat = new THREE.MeshPhongMaterial({ color: col });
        const box = new THREE.Mesh(geo, mat);

        // è‡ªå‹•ã‚¹ã‚¿ãƒƒã‚­ãƒ³ã‚°è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼šåº•ã‹ã‚‰é †ã«ç©ã¿ä¸Šã’ï¼‰
        const offset = selectedObj.userData.cases.length * 2; // é‡ãªã‚Šé˜²æ­¢ã®å¾®å¢—åˆ†
        const parentH = selectedObj.geometry.parameters.height;
        box.position.set(0, -parentH/2 + ch/2 + offset, 0);
        
        // ãƒ©ãƒ™ãƒ«
        box.add(createLabel(labelText));
        selectedObj.add(box);
        selectedObj.userData.cases.push({ label: labelText });
        updateCaseList();
    }

    function createLabel(text) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 256; canvas.height = 64;
        ctx.fillStyle = 'white'; ctx.font = 'bold 30px sans-serif';
        ctx.textAlign = 'center'; ctx.fillText(text, 128, 45);
        const tex = new THREE.CanvasTexture(canvas);
        const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
        sprite.scale.set(30, 8, 1);
        sprite.position.y = 0; sprite.position.z = 11; // æ‰‹å‰ã«è¡¨ç¤º
        return sprite;
    }

    // --- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ ---
    function onPointerDown(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(furnitureList);

        if (intersects.length > 0) {
            selectObject(intersects[0].object);
            // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ï¼ˆåºŠå¹³é¢ã¨ã®äº¤å·®ã‚’åˆ©ç”¨ï¼‰
            const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
            const dragOffset = new THREE.Vector3();
            const moveHandler = (e) => {
                const pointer = e.touches ? e.touches[0] : e;
                mouse.x = (pointer.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(pointer.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersectPoint = new THREE.Vector3();
                if (raycaster.ray.intersectPlane(plane, intersectPoint)) {
                    selectedObj.position.x = intersectPoint.x;
                    selectedObj.position.z = intersectPoint.z;
                }
            };
            const upHandler = () => {
                window.removeEventListener('mousemove', moveHandler);
                window.removeEventListener('touchmove', moveHandler);
                controls.enabled = true;
            };
            controls.enabled = false;
            window.addEventListener('mousemove', moveHandler);
            window.addEventListener('touchmove', moveHandler);
            window.addEventListener('mouseup', upHandler, {once:true});
            window.addEventListener('touchend', upHandler, {once:true});
        }
    }

    function selectObject(obj) {
        if (selectedObj) selectedObj.material.emissive.setHex(0x000000);
        selectedObj = obj;
        selectedObj.material.emissive.setHex(0x333333);
        
        document.getElementById('storage-active-ui').style.display = 'block';
        document.getElementById('storage-idle-msg').style.display = 'none';
        document.getElementById('edit-target-name').innerText = `ç·¨é›†ä¸­ã®å®¶å…· ID: ${obj.uuid.slice(0,5)}`;
        updateCaseList();
    }

    function updateCaseList() {
        const container = document.getElementById('case-list');
        container.innerHTML = '<strong>ä¸­èº«ãƒªã‚¹ãƒˆ:</strong>';
        selectedObj.userData.cases.forEach(c => {
            const div = document.createElement('div');
            div.className = 'shelf-item';
            div.innerHTML = `<span>ğŸ·ï¸ ${c.label}</span>`;
            container.appendChild(div);
        });
    }

    function deleteSelected() {
        if (!selectedObj) return;
        scene.remove(selectedObj);
        furnitureList.splice(furnitureList.indexOf(selectedObj), 1);
        selectedObj = null;
        document.getElementById('storage-active-ui').style.display = 'none';
        document.getElementById('storage-idle-msg').style.display = 'block';
    }

    function onResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
</script>
</body>
</html>
