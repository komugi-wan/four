<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTAKU-ROOM Manager Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/DragControls.js"></script>
    <style>
        :root { --accent: #ff4757; --bg: #1e1e2e; }
        body { margin: 0; overflow: hidden; font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: white; }
        canvas { display: block; }
        
        #ui-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; max-height: 45%;
            background: rgba(30, 30, 46, 0.95); border-top: 3px solid var(--accent);
            overflow-y: auto; padding: 15px; box-sizing: border-box; z-index: 100;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
        }

        .tabs { display: flex; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid #444; }
        .tab { padding: 8px 15px; cursor: pointer; font-size: 13px; opacity: 0.6; }
        .tab.active { opacity: 1; border-bottom: 2px solid var(--accent); font-weight: bold; }

        .menu-section { display: none; }
        .menu-section.active { display: block; }
        
        h3 { margin: 0 0 10px 0; color: var(--accent); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .input-group { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px; }
        
        input, button, select {
            background: #313244; color: white; border: 1px solid #45475a;
            padding: 10px; border-radius: 6px; font-size: 12px; outline: none;
        }
        input[type="number"] { width: 60px; }
        button { cursor: pointer; transition: 0.2s; background: #45475a; }
        button:hover { background: #585b70; }
        .btn-primary { background: var(--accent); border: none; font-weight: bold; padding: 10px 20px; }
        .btn-primary:hover { background: #ff6b81; }

        #instructions {
            position: absolute; top: 10px; left: 10px; font-size: 11px;
            background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; pointer-events: none;
        }
        .status-bar { position: absolute; top: 10px; right: 10px; font-size: 12px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="instructions">
    ğŸ–±ï¸ å›è»¢: å·¦ãƒ‰ãƒ©ãƒƒã‚° | â†•ï¸ ã‚ºãƒ¼ãƒ : ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«<br>
    ğŸ–ï¸ ç§»å‹•: å®¶å…·ã‚’ç›´æ¥ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆåºŠã«æ²¿ã£ã¦å‹•ãã¾ã™ï¼‰<br>
    ğŸ“¦ é¸æŠ: å®¶å…·ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¸­èº«ã‚’ç·¨é›†
</div>

<div class="status-bar" id="status">éƒ¨å±‹ãƒ¢ãƒ¼ãƒ‰</div>

<div id="ui-panel">
    <div class="tabs">
        <div class="tab active" onclick="showTab('room')">1. éƒ¨å±‹ä½œæˆ</div>
        <div class="tab" onclick="showTab('furniture')">2. å®¶å…·é…ç½®</div>
        <div class="tab" onclick="showTab('storage')">3. ä¸­èº«ã®ç®¡ç†</div>
    </div>

    <div id="sec-room" class="menu-section active">
        <h3>éƒ¨å±‹ã®å½¢çŠ¶ã¨è‰²</h3>
        <div class="input-group">
            <label>é ‚ç‚¹åº§æ¨™ (x,y):</label>
            <input type="text" id="room-points" value="0,0, 400,0, 400,300, 200,300, 200,500, 0,500" style="width: 250px;">
            <input type="color" id="floor-color" value="#45475a">
            <button onclick="updateFloor()" class="btn-primary">åºŠã‚’æ›´æ–°</button>
        </div>
    </div>

    <div id="sec-furniture" class="menu-section">
        <h3>æ–°è¦å®¶å…·ã‚’è¿½åŠ </h3>
        <div class="input-group">
            å¹…:<input type="number" id="f-w" value="60"> 
            é«˜:<input type="number" id="f-h" value="90"> 
            å¥¥:<input type="number" id="f-d" value="30">
            è‰²:<input type="color" id="f-color" value="#89b4fa">
            <button onclick="addFurniture()" class="btn-primary">é…ç½®ã™ã‚‹</button>
        </div>
    </div>

    <div id="sec-storage" class="menu-section">
        <h3 id="selected-title">å®¶å…·ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
        <div id="storage-controls" style="display:none;">
            <div class="input-group">
                ãƒ©ãƒ™ãƒ«:<input type="text" id="c-label" placeholder="ä¾‹ï¼šãƒ•ã‚£ã‚®ãƒ¥ã‚¢" value="BOX A">
                å¹…:<input type="number" id="c-w" value="20">
                é«˜:<input type="number" id="c-h" value="15">
                å¥¥:<input type="number" id="c-d" value="20">
                <input type="color" id="c-color" value="#fab387">
                <button onclick="addStorageCase()" class="btn-primary">ã‚±ãƒ¼ã‚¹ã‚’ä¸­ã«é…ç½®</button>
            </div>
            <button onclick="deleteSelected()" style="background:#f38ba8">é¸æŠä¸­ã®å®¶å…·ã‚’å‰Šé™¤</button>
        </div>
    </div>
</div>

<script>
    let scene, camera, renderer, controls, dragControls;
    let floorMesh, selectedFurniture = null;
    let furnitureList = [];
    let selectableObjects = [];

    init();
    animate();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x181825);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.set(400, 500, 600);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        
        // ç…§æ˜
        const ambLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(200, 800, 400);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // åºŠã®åˆæœŸç”Ÿæˆ
        updateFloor();
        
        // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã®åˆæœŸåŒ–
        initDragControls();

        // ã‚¯ãƒªãƒƒã‚¯ã«ã‚ˆã‚‹é¸æŠ
        window.addEventListener('mousedown', onSelect, false);
        window.addEventListener('resize', onWindowResize, false);
    }

    function initDragControls() {
        if(dragControls) dragControls.dispose();
        dragControls = new THREE.DragControls(furnitureList, camera, renderer.domElement);
        
        dragControls.addEventListener('dragstart', function (event) {
            controls.enabled = false;
            selectFurniture(event.object);
        });
        
        dragControls.addEventListener('drag', function (event) {
            // Yè»¸ï¼ˆé«˜ã•ï¼‰ã‚’å›ºå®šã—ã¦åºŠã®ä¸Šã‚’æ»‘ã‚‰ã›ã‚‹
            if (event.object.userData.type === 'furniture') {
                event.object.position.y = event.object.geometry.parameters.height / 2;
            }
        });

        dragControls.addEventListener('dragend', function (event) {
            controls.enabled = true;
        });
    }

    function updateFloor() {
        if (floorMesh) scene.remove(floorMesh);
        
        const color = document.getElementById('floor-color').value;
        const rawPoints = document.getElementById('room-points').value.split(',');
        const shape = new THREE.Shape();
        
        const pts = [];
        for (let i = 0; i < rawPoints.length; i += 2) {
            const x = parseFloat(rawPoints[i]);
            const z = parseFloat(rawPoints[i+1]);
            pts.push(new THREE.Vector2(x, z));
            if (i === 0) shape.moveTo(x, z);
            else shape.lineTo(x, z);
        }

        const geometry = new THREE.ShapeGeometry(shape);
        const material = new THREE.MeshPhongMaterial({ color: color, side: THREE.DoubleSide });
        floorMesh = new THREE.Mesh(geometry, material);
        floorMesh.rotation.x = -Math.PI / 2;
        floorMesh.receiveShadow = true;
        scene.add(floorMesh);
    }

    function addFurniture() {
        const w = parseFloat(document.getElementById('f-w').value);
        const h = parseFloat(document.getElementById('f-h').value);
        const d = parseFloat(document.getElementById('f-d').value);
        const col = document.getElementById('f-color').value;

        const geo = new THREE.BoxGeometry(w, h, d);
        // å°‘ã—é€éã•ã›ã¦ä¸­èº«ã‚’è¦‹ã‚„ã™ãã™ã‚‹
        const mat = new THREE.MeshPhongMaterial({ color: col, transparent: true, opacity: 0.7 });
        const mesh = new THREE.Mesh(geo, mat);
        
        mesh.position.set(100, h/2, 100);
        mesh.userData = { type: 'furniture', cases: [] };
        mesh.castShadow = true;

        // æ ç·šã‚’è¿½åŠ 
        const edges = new THREE.EdgesGeometry(geo);
        const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff }));
        mesh.add(line);

        scene.add(mesh);
        furnitureList.push(mesh);
        initDragControls(); // ãƒ‰ãƒ©ãƒƒã‚°å¯¾è±¡ã‚’æ›´æ–°
        selectFurniture(mesh);
        showTab('storage');
    }

    function selectFurniture(obj) {
        if (selectedFurniture) {
            selectedFurniture.material.emissive.setHex(0x000000);
        }
        selectedFurniture = obj;
        selectedFurniture.material.emissive.setHex(0x222222);

        document.getElementById('selected-title').innerText = "å®¶å…·ã‚’ç·¨é›†ä¸­";
        document.getElementById('storage-controls').style.display = 'block';
        document.getElementById('status').innerText = "å®¶å…·é¸æŠä¸­: " + obj.uuid.slice(0,5);
    }

    function addStorageCase() {
        if (!selectedFurniture) return;

        const label = document.getElementById('c-label').value;
        const cw = parseFloat(document.getElementById('c-w').value);
        const ch = parseFloat(document.getElementById('c-h').value);
        const cd = parseFloat(document.getElementById('c-d').value);
        const col = document.getElementById('c-color').value;

        const geo = new THREE.BoxGeometry(cw, ch, cd);
        const mat = new THREE.MeshPhongMaterial({ color: col });
        const storage = new THREE.Mesh(geo, mat);

        // è¦ªå®¶å…·ã®ä¸­ã§ã®åˆæœŸä½ç½®ï¼ˆåº•ã«ç½®ãï¼‰
        const parentH = selectedFurniture.geometry.parameters.height;
        storage.position.set(0, -parentH/2 + ch/2, 0);
        
        // ãƒ©ãƒ™ãƒ«ï¼ˆã‚¹ãƒ—ãƒ©ã‚¤ãƒˆï¼‰ä½œæˆ
        storage.add(createLabelSprite(label));

        selectedFurniture.add(storage);
    }

    function createLabelSprite(text) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 256; canvas.height = 64;
        ctx.fillStyle = 'rgba(0,0,0,0.8)';
        ctx.fillRect(0, 0, 256, 64);
        ctx.fillStyle = 'white';
        ctx.font = 'bold 32px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(text, 128, 45);

        const tex = new THREE.CanvasTexture(canvas);
        const mat = new THREE.SpriteMaterial({ map: tex });
        const sprite = new THREE.Sprite(mat);
        sprite.scale.set(40, 10, 1);
        sprite.position.y = 10; // ç®±ã®å°‘ã—ä¸Šã«è¡¨ç¤º
        return sprite;
    }

    function onSelect(event) {
        const mouse = new THREE.Vector2();
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(furnitureList);

        if (intersects.length > 0) {
            selectFurniture(intersects[0].object);
        }
    }

    function deleteSelected() {
        if (!selectedFurniture) return;
        scene.remove(selectedFurniture);
        furnitureList = furnitureList.filter(f => f !== selectedFurniture);
        selectedFurniture = null;
        document.getElementById('storage-controls').style.display = 'none';
        document.getElementById('selected-title').innerText = "å®¶å…·ã‚’é¸æŠã—ã¦ãã ã•ã„";
        initDragControls();
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.menu-section').forEach(s => s.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById('sec-' + tabName).classList.add('active');
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
</script>

</body>
</html>
