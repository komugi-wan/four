<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Spreadsheet App</title>
    <style>
        :root {
            --header-bg: #f8f9fa;
            --border-color: #ddd;
            --accent-color: #1a73e8;
            --cell-width: 100px;
            --row-height: 32px;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; color: #333; }
        
        /* ツールバーの装飾 */
        .toolbar { 
            background: #fff; padding: 12px; border-bottom: 1px solid var(--border-color); 
            display: flex; gap: 10px; align-items: center; flex-wrap: wrap; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 100;
        }
        
        .table-container { overflow: auto; flex-grow: 1; position: relative; -webkit-overflow-scrolling: touch; background: #fff; }
        
        table { border-collapse: collapse; table-layout: fixed; width: 0; /* 内容に合わせて広がるように設定 */ } 
        
        /* ヘッダー固定 (Sticky) */
        th { 
            background: var(--header-bg); border: 1px solid var(--border-color); 
            position: sticky; top: 0; z-index: 20; font-size: 12px; font-weight: 600; 
            user-select: none; height: var(--row-height); box-sizing: border-box;
        }

        /* 行ヘッダーの固定 */
        .row-header { 
            left: 0; z-index: 30; width: 50px; text-align: center; background: var(--header-bg);
        }
        
        /* 交差する左上のセル */
        tr:first-child th:first-child { z-index: 40; }

        td { border: 1px solid var(--border-color); padding: 0; box-sizing: border-box; height: var(--row-height); }
        
        /* セル入力欄 */
        td input { 
            border: none; width: 100%; height: 100%; padding: 0 8px; 
            box-sizing: border-box; outline: none; font-size: 14px;
            background: transparent; display: block;
        }
        td input:focus { border: 2px solid var(--accent-color); padding: 0 7px; background: #fff; }

        /* リサイザー */
        .resizer-h {
            position: absolute; right: -5px; top: 0; width: 10px; height: 100%;
            cursor: col-resize; z-index: 50; touch-action: none;
        }
        .resizer-v {
            position: absolute; bottom: -5px; left: 0; width: 100%; height: 10px;
            cursor: row-resize; z-index: 50; touch-action: none;
        }
        
        .resizer-h::after { content: ''; position: absolute; right: 4px; top: 0; width: 1px; height: 100%; background: transparent; }
        .resizer-v::after { content: ''; position: absolute; bottom: 4px; left: 0; width: 100%; height: 1px; background: transparent; }
        .resizer-h:hover::after, .resizer-v:hover::after { background: var(--accent-color); }

        button { 
            cursor: pointer; padding: 8px 16px; background: #fff; border: 1px solid #ced4da; 
            border-radius: 4px; font-size: 14px; transition: all 0.2s; font-weight: 500;
        }
        button:hover { background: #f1f3f4; border-color: #1a73e8; color: #1a73e8; }
        button:active { background: #e8f0fe; }
    </style>
</head>
<body>

<div class="toolbar">
    <button onclick="addRow()">行を追加 (+)</button>
    <button onclick="addCol()">列を追加 (+)</button>
    <button onclick="exportCSV()">CSV書き出し</button>
    <span style="font-size: 12px; color: #777; margin-left: 10px;">※境界をドラッグでサイズ調整</span>
</div>

<div class="table-container">
    <table id="spreadsheet">
        <thead>
            <tr id="header-row">
                <th class="row-header"></th>
                </tr>
        </thead>
        <tbody id="table-body">
            </tbody>
    </table>
</div>

<script>
    const headerRow = document.getElementById('header-row');
    const tableBody = document.getElementById('table-body');
    
    let rowCount = 20;
    let colCount = 10;
    const DEFAULT_COL_WIDTH = 100;

    function getColName(n) {
        let name = "";
        while (n >= 0) {
            name = String.fromCharCode((n % 26) + 65) + name;
            n = Math.floor(n / 26) - 1;
        }
        return name;
    }

    function initTable() {
        // 先にヘッダーを作成
        for (let i = 0; i < colCount; i++) createColHeader(i);
        // 次に行を作成
        for (let i = 0; i < rowCount; i++) createRow(i);
    }

    function createColHeader(index) {
        const th = document.createElement('th');
        th.style.width = DEFAULT_COL_WIDTH + 'px';
        th.innerHTML = `<span>${getColName(index)}</span>`;
        
        const resizer = document.createElement('div');
        resizer.className = 'resizer-h';
        resizer.addEventListener('mousedown', initResizeCol);
        resizer.addEventListener('touchstart', initResizeCol, {passive: false});
        th.appendChild(resizer);
        
        headerRow.appendChild(th);
    }

    function createRow(rowIndex) {
        const tr = document.createElement('tr');
        
        // 行番号ヘッダー
        const th = document.createElement('th');
        th.className = 'row-header';
        th.innerText = rowIndex + 1;
        
        const resizer = document.createElement('div');
        resizer.className = 'resizer-v';
        resizer.addEventListener('mousedown', initResizeRow);
        resizer.addEventListener('touchstart', initResizeRow, {passive: false});
        th.appendChild(resizer);
        tr.appendChild(th);

        // データセル
        for (let i = 0; i < colCount; i++) {
            tr.appendChild(createCell());
        }
        tableBody.appendChild(tr);
    }

    function createCell() {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        // 入力補完をオフにして使いやすく
        input.setAttribute('autocomplete', 'off');
        input.setAttribute('spellcheck', 'false');
        td.appendChild(input);
        return td;
    }

    function addRow() {
        createRow(rowCount++);
    }

    function addCol() {
        createColHeader(colCount++);
        Array.from(tableBody.rows).forEach(row => {
            row.appendChild(createCell());
        });
    }

    // 座標取得の共通化
    const getX = e => e.touches ? e.touches[0].clientX : e.clientX;
    const getY = e => e.touches ? e.touches[0].clientY : e.clientY;

    function initResizeCol(e) {
        if (e.cancelable) e.preventDefault();
        const th = e.target.parentElement;
        const startX = getX(e);
        const startWidth = th.offsetWidth;
        
        const onMove = (ev) => {
            const newWidth = startWidth + getX(ev) - startX;
            if (newWidth > 40) {
                th.style.width = newWidth + 'px';
                th.style.minWidth = newWidth + 'px'; // 強制適用
            }
        };
        
        const onEnd = () => {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onEnd);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onEnd);
        };

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
        document.addEventListener('touchmove', onMove, {passive: false});
        document.addEventListener('touchend', onEnd);
    }

    function initResizeRow(e) {
        if (e.cancelable) e.preventDefault();
        const tr = e.target.parentElement.parentElement;
        const startY = getY(e);
        const startHeight = tr.offsetHeight;

        const onMove = (ev) => {
            const newHeight = startHeight + getY(ev) - startY;
            if (newHeight > 20) {
                tr.style.height = newHeight + 'px';
            }
        };

        const onEnd = () => {
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('mouseup', onEnd);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onEnd);
        };

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
        document.addEventListener('touchmove', onMove, {passive: false});
        document.addEventListener('touchend', onEnd);
    }

    function exportCSV() {
        let csv = "";
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            const rowData = Array.from(inputs)
                .map(input => {
                    let val = input.value.replace(/"/g, '""'); // ダブルクォートのエスケープ
                    return `"${val}"`;
                })
                .join(",");
            csv += rowData + "\r\n";
        });
        
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // Excelでの文字化け防止 (UTF-8 BOM)
        const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `spreadsheet_${new Date().getTime()}.csv`;
        link.click();
        URL.revokeObjectURL(url);
    }

    initTable();
</script>

</body>
</html>
