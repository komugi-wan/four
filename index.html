<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTK-Room Manager Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root { --accent: #00d2ff; --bg: #05050a; --panel: rgba(15, 15, 25, 0.95); --text: #e0e0e0; }
        body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); touch-action: none; }
        canvas { display: block; height: 50vh !important; }
        
        #ui-panel {
            position: absolute; bottom: 0; width: 100%; height: 50%;
            background: var(--panel); border-top: 2px solid var(--accent);
            overflow-y: auto; box-sizing: border-box; z-index: 100;
        }

        .tabs { display: flex; position: sticky; top: 0; background: #1a1a2e; z-index: 10; border-bottom: 1px solid #333; }
        .tab { flex: 1; padding: 12px; text-align: center; font-size: 13px; cursor: pointer; opacity: 0.6; transition: 0.3s; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--accent); font-weight: bold; background: rgba(0,210,255,0.1); }

        .content { padding: 15px; }
        .menu-section { display: none; }
        .menu-section.active { display: block; }
        
        .control-group { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .input-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        label { font-size: 11px; color: #aaa; width: 100%; margin-bottom: 4px; display: block; }
        
        input, select, button { 
            background: #222; color: white; border: 1px solid #444;
            padding: 10px; border-radius: 6px; font-size: 14px; outline: none;
        }
        input[type="number"] { width: 70px; }
        input[type="text"], select { flex-grow: 1; }
        
        .btn-main { background: var(--accent); color: #000; width: 100%; font-weight: bold; border: none; margin-top: 5px; cursor: pointer; }
        .btn-sub { background: #333; color: white; width: 100%; margin-top: 8px; font-size: 12px; border: none; }

        .shelf-item { 
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px; background: rgba(255,255,255,0.05); margin-top: 5px; border-radius: 4px; font-size: 12px;
        }
        #overlay { position: absolute; top: 10px; left: 10px; font-size: 10px; color: #888; pointer-events: none; }
    </style>
</head>
<body>

<div id="overlay">ã‚¿ãƒƒãƒ—ã§å®¶å…·é¸æŠ / ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹•</div>

<div id="ui-panel">
    <div class="tabs">
        <div class="tab active" onclick="showTab('sec-room')">1. éƒ¨å±‹</div>
        <div class="tab" onclick="showTab('sec-furniture')">2. å®¶å…·</div>
        <div class="tab" onclick="showTab('sec-storage')">3. åç´ç‰©</div>
    </div>

    <div class="content">
        <div id="sec-room" class="menu-section active">
            <div class="control-group">
                <label>é–“å–ã‚Šåº§æ¨™ (x,z) â€»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š</label>
                <input type="text" id="room-points" value="0,0, 400,0, 400,300, 200,300, 200,450, 0,450">
                <div class="input-row" style="margin-top:10px;">
                    <div><label>å¤©äº•é«˜</label><input type="number" id="wall-h" value="240"></div>
                    <div><label>åºŠè‰²</label><input type="color" id="floor-color" value="#1a1a1a"></div>
                </div>
                <button class="btn-main" onclick="buildRoom()">é–“å–ã‚Šã‚’ç¢ºå®š</button>
            </div>
        </div>

        <div id="sec-furniture" class="menu-section">
            <div class="control-group">
                <label>å®¶å…·ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
                <select id="f-preset" onchange="applyPreset()">
                    <option value="custom">ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ã‚º</option>
                    <option value="cb3">ã‚«ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹3æ®µ (42x88x29)</option>
                    <option value="bookshelf">å¤§å®¹é‡æœ¬æ£š (90x180x30)</option>
                    <option value="acrylic">ã‚¢ã‚¯ã‚¹ã‚¿æ£š (60x40x15)</option>
                </select>
                <div class="input-row" style="margin-top:10px;">
                    <div><label>å¹…(W)</label><input type="number" id="f-w" value="42"></div>
                    <div><label>é«˜(H)</label><input type="number" id="f-h" value="88"></div>
                    <div><label>å¥¥(D)</label><input type="number" id="f-d" value="29"></div>
                    <div><label>è‰²</label><input type="color" id="f-color" value="#5d4037"></div>
                </div>
                <button class="btn-main" onclick="addFurniture()">å®¶å…·ã‚’è¨­ç½®</button>
            </div>
        </div>

        <div id="sec-storage" class="menu-section">
            <div id="storage-active-ui" style="display:none;">
                <h3 id="edit-target-name" style="margin:0 0 10px; font-size:16px; color:var(--accent);">å®¶å…·ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
                <div class="control-group">
                    <label>åç´ç‰©ã®åç§°/ãƒ©ãƒ™ãƒ«</label>
                    <input type="text" id="c-label" placeholder="ä¾‹ï¼šç¼¶ãƒãƒƒã‚¸ Aã‚°ãƒ«ãƒ¼ãƒ—">
                    <div class="input-row" style="margin-top:10px;">
                        <div><label>å¹…</label><input type="number" id="c-w" value="20"></div>
                        <div><label>é«˜</label><input type="number" id="c-h" value="10"></div>
                        <div><label>å¥¥</label><input type="number" id="c-d" value="25"></div>
                        <div><label>è‰²</label><input type="color" id="c-color" value="#e91e63"></div>
                    </div>
                    <button class="btn-main" onclick="addCase()" style="background:#4caf50;">ä¸­ã«åç´ã™ã‚‹</button>
                </div>
                <button class="btn-sub" onclick="deleteSelected()">å®¶å…·ã‚’æ’¤å»</button>
                <div id="case-list-container">
                    <p style="font-size:11px; color:#888; margin-bottom:5px;">å†…å®¹ç‰©ãƒªã‚¹ãƒˆ:</p>
                    <div id="case-list"></div>
                </div>
            </div>
            <div id="storage-idle-msg" style="text-align:center; padding-top:40px; color:#555;">
                3Dç”»é¢ä¸Šã®å®¶å…·ã‚’ã‚¿ãƒƒãƒ—ã—ã¦<br>ä¸­èº«ã‚’ç®¡ç†
            </div>
        </div>
    </div>
</div>

<script>
    let scene, camera, renderer, controls, raycaster, mouse;
    let floorMesh, wallGroup, selectedObj = null;
    const furnitureList = [];

    init();
    animate();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x05050a);

        camera = new THREE.PerspectiveCamera(50, window.innerWidth / (window.innerHeight * 0.5), 1, 5000);
        camera.position.set(500, 600, 500);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight * 0.5);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.insertBefore(renderer.domElement, document.getElementById('ui-panel'));

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        const ambLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
        dirLight.position.set(100, 200, 100);
        scene.add(dirLight);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        wallGroup = new THREE.Group();
        scene.add(wallGroup);

        buildRoom();

        renderer.domElement.addEventListener('pointerdown', onPointerDown, false);
        window.addEventListener('resize', onResize);
    }

    function showTab(id) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.menu-section').forEach(s => s.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(id).classList.add('active');
    }

    function buildRoom() {
        if (floorMesh) scene.remove(floorMesh);
        wallGroup.clear();

        const pointsRaw = document.getElementById('room-points').value.split(',').map(n => parseFloat(n.trim()));
        const wallH = parseFloat(document.getElementById('wall-h').value);
        const pts = [];
        for (let i = 0; i < pointsRaw.length; i += 2) {
            pts.push(new THREE.Vector2(pointsRaw[i], pointsRaw[i + 1]));
        }

        const shape = new THREE.Shape(pts);
        const floorGeo = new THREE.ShapeGeometry(shape);
        const floorMat = new THREE.MeshPhongMaterial({ color: document.getElementById('floor-color').value, side: THREE.DoubleSide });
        floorMesh = new THREE.Mesh(floorGeo, floorMat);
        floorMesh.rotation.x = -Math.PI / 2;
        scene.add(floorMesh);

        // å¢ƒç•Œç·šã‚’å›ã—ã¦å£ã‚’ä½œã‚‹
        const shapePts = shape.getPoints();
        shapePts.forEach((p, i) => {
            const nextP = shapePts[(i + 1) % shapePts.length];
            const dist = p.distanceTo(nextP);
            const wallGeo = new THREE.PlaneGeometry(dist, wallH);
            const wallMat = new THREE.MeshPhongMaterial({ color: 0x222233, transparent: true, opacity: 0.4, side: THREE.DoubleSide });
            const wall = new THREE.Mesh(wallGeo, wallMat);

            const angle = Math.atan2(nextP.y - p.y, nextP.x - p.x);
            wall.position.set((p.x + nextP.x)/2, wallH/2, (p.y + nextP.y)/2);
            wall.rotation.y = -angle;
            wallGroup.add(wall);
            
            const edgeGeo = new THREE.EdgesGeometry(wallGeo);
            const edge = new THREE.LineSegments(edgeGeo, new THREE.LineBasicMaterial({ color: 0x444466 }));
            wall.add(edge);
        });
    }

    function applyPreset() {
        const p = document.getElementById('f-preset').value;
        const w = document.getElementById('f-w'), h = document.getElementById('f-h'), d = document.getElementById('f-d');
        if(p === 'cb3') { w.value = 42; h.value = 88; d.value = 29; }
        else if(p === 'bookshelf') { w.value = 90; h.value = 180; d.value = 30; }
        else if(p === 'acrylic') { w.value = 60; h.value = 40; d.value = 15; }
    }

    function addFurniture() {
        const w = parseFloat(document.getElementById('f-w').value);
        const h = parseFloat(document.getElementById('f-h').value);
        const d = parseFloat(document.getElementById('f-d').value);
        const col = document.getElementById('f-color').value;

        const geo = new THREE.BoxGeometry(w, h, d);
        const mat = new THREE.MeshPhongMaterial({ color: col, transparent: true, opacity: 0.7 });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(w/2, h/2, d/2);
        
        // åç´ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨
        mesh.userData = { 
            type: 'furniture', 
            size: {w, h, d},
            cases: [], 
            lastY: -h/2 // åº•é¢ã‹ã‚‰ã®ç©ã¿ä¸Šã’ç”¨
        };

        const wire = new THREE.LineSegments(new THREE.EdgesGeometry(geo), new THREE.LineBasicMaterial({ color: 0xffffff, opacity: 0.5, transparent: true }));
        mesh.add(wire);

        scene.add(mesh);
        furnitureList.push(mesh);
        selectObject(mesh);
        showTab('sec-storage');
    }

    function addCase() {
        if (!selectedObj) return;
        const labelText = document.getElementById('c-label').value || "Unnamed Item";
        const cw = parseFloat(document.getElementById('c-w').value);
        const ch = parseFloat(document.getElementById('c-h').value);
        const cd = parseFloat(document.getElementById('c-d').value);
        const col = document.getElementById('c-color').value;

        const geo = new THREE.BoxGeometry(cw, ch, cd);
        const mat = new THREE.MeshPhongMaterial({ color: col });
        const box = new THREE.Mesh(geo, mat);

        // ã‚·ãƒ³ãƒ—ãƒ«ãªç©ã¿ä¸Šã’ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå®Ÿéš›ã¯æ£šæ¿åˆ¤å®šç­‰ã‚’å…¥ã‚Œã‚‹ã¨ã‚ˆã‚Šãƒªã‚¢ãƒ«ï¼‰
        const yPos = selectedObj.userData.lastY + ch/2;
        if (yPos + ch/2 > selectedObj.userData.size.h/2) {
            alert("ã“ã‚Œä»¥ä¸Šå…¥ã‚Šã¾ã›ã‚“ï¼");
            return;
        }
        
        box.position.set(0, yPos, 0);
        selectedObj.userData.lastY += ch + 0.2;

        // ãƒ©ãƒ™ãƒ«ä½œæˆ
        const sprite = createLabelSprite(labelText);
        sprite.position.set(0, 0, cd/2 + 0.1);
        box.add(sprite);
        
        selectedObj.add(box);
        selectedObj.userData.cases.push({ label: labelText, color: col });
        updateCaseListUI();
    }

    function createLabelSprite(text) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 256; canvas.height = 64;
        ctx.fillStyle = 'rgba(0,0,0,0.8)';
        ctx.fillRect(0, 0, 256, 64);
        ctx.strokeStyle = varProp('--accent');
        ctx.lineWidth = 4;
        ctx.strokeRect(0, 0, 256, 64);
        ctx.fillStyle = 'white';
        ctx.font = 'bold 32px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(text, 128, 45);

        const texture = new THREE.CanvasTexture(canvas);
        const spriteMat = new THREE.SpriteMaterial({ map: texture });
        const sprite = new THREE.Sprite(spriteMat);
        sprite.scale.set(20, 5, 1);
        return sprite;
    }

    function varProp(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function onPointerDown(event) {
        const rect = renderer.domElement.getBoundingClientRect();
        mouse.x = (event.clientX / rect.width) * 2 - 1;
        mouse.y = -(event.clientY / rect.height) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(furnitureList);

        if (intersects.length > 0) {
            const obj = intersects[0].object;
            selectObject(obj);

            // ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•
            const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
            const onPointerMove = (e) => {
                const p = e.touches ? e.touches[0] : e;
                mouse.x = (p.clientX / rect.width) * 2 - 1;
                mouse.y = -(p.clientY / rect.height) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersectPoint = new THREE.Vector3();
                if (raycaster.ray.intersectPlane(plane, intersectPoint)) {
                    obj.position.x = Math.round(intersectPoint.x / 5) * 5; // ã‚¹ãƒŠãƒƒãƒ—
                    obj.position.z = Math.round(intersectPoint.z / 5) * 5;
                }
            };
            const onPointerUp = () => {
                window.removeEventListener('pointermove', onPointerMove);
                controls.enabled = true;
            };
            controls.enabled = false;
            window.addEventListener('pointermove', onPointerMove);
            window.addEventListener('pointerup', onPointerUp, {once: true});
        }
    }

    function selectObject(obj) {
        if (selectedObj) selectedObj.material.emissive.setHex(0x000000);
        selectedObj = obj;
        selectedObj.material.emissive.setHex(0x333333);
        
        document.getElementById('storage-active-ui').style.display = 'block';
        document.getElementById('storage-idle-msg').style.display = 'none';
        document.getElementById('edit-target-name').innerText = `é¸æŠä¸­: å®¶å…·`;
        updateCaseListUI();
    }

    function updateCaseListUI() {
        const container = document.getElementById('case-list');
        container.innerHTML = '';
        selectedObj.userData.cases.forEach(c => {
            const div = document.createElement('div');
            div.className = 'shelf-item';
            div.innerHTML = `<span>ğŸ“¦ ${c.label}</span><div style="width:12px;height:12px;background:${c.color};border-radius:2px;"></div>`;
            container.appendChild(div);
        });
    }

    function deleteSelected() {
        if (!selectedObj) return;
        scene.remove(selectedObj);
        furnitureList.splice(furnitureList.indexOf(selectedObj), 1);
        selectedObj = null;
        document.getElementById('storage-active-ui').style.display = 'none';
        document.getElementById('storage-idle-msg').style.display = 'block';
    }

    function onResize() {
        camera.aspect = window.innerWidth / (window.innerHeight * 0.5);
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight * 0.5);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
</script>
</body>
</html>
