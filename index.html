<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTK-Room Storage Designer v2.5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root { 
            --accent: #4ade80; --accent-dark: #166534;
            --sub: #f472b6; --bg: #0f172a; 
            --panel: #1e293b; --text: #f8fafc; 
            --danger: #ef4444; --card: rgba(255,255,255,0.07);
        }
        body { margin: 0; overflow: hidden; font-family: 'Hiragino Kaku Gothic ProN', sans-serif; background: var(--bg); color: var(--text); touch-action: none; }
        
        #view-container { height: 100vh; width: 100%; position: absolute; }
        
        /* UI Layout */
        #ui-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60vh;
            background: var(--panel); border-top: 3px solid var(--accent);
            border-radius: 24px 24px 0 0; z-index: 100; 
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -15px 40px rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
        }
        #ui-panel.collapsed { transform: translateY(calc(60vh - 50px)); }
        
        .panel-toggle {
            width: 100%; height: 50px; display: flex; justify-content: center; align-items: center; 
            background: rgba(255,255,255,0.03); cursor: pointer;
        }
        .handle-bar { width: 40px; height: 4px; background: #475569; border-radius: 2px; }

        .view-controls {
            position: fixed; top: 15px; left: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 50;
        }
        .v-btn { 
            background: rgba(15, 23, 42, 0.85); color: white; border: 1px solid rgba(255,255,255,0.2); 
            padding: 10px; border-radius: 12px; font-size: 14px; backdrop-filter: blur(10px);
            width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
        }

        .tabs { display: flex; padding: 0 10px; gap: 5px; background: rgba(0,0,0,0.2); }
        .tab { 
            flex: 1; padding: 12px; text-align: center; font-size: 13px; 
            background: transparent; border-bottom: 3px solid transparent; opacity: 0.5;
        }
        .tab.active { border-bottom: 3px solid var(--accent); opacity: 1; color: var(--accent); font-weight: bold; }

        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 40px; }
        .card { background: var(--card); padding: 16px; border-radius: 16px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .grid-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px; }
        label { display: block; font-size: 11px; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
        input, select { 
            width: 100%; background: #0f172a; border: 1px solid #334155; color: white; 
            padding: 12px; border-radius: 10px; font-size: 14px; box-sizing: border-box; outline: none;
        }
        input:focus { border-color: var(--accent); }

        .btn-main { background: var(--accent); color: #064e3b; border: none; width: 100%; padding: 16px; border-radius: 12px; font-weight: 800; font-size: 15px; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }
        .btn-sub { background: #334155; color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: bold; }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; padding: 8px; border-radius: 8px; font-size: 12px; }
        
        .action-bar { display: flex; gap: 10px; margin-top: 15px; }
        .item-row { 
            background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; 
            margin-top: 8px; display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid var(--sub);
        }
        
        #guide-msg { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: #064e3b; padding: 8px 20px; 
            border-radius: 30px; font-size: 13px; font-weight: bold; 
            display: none; z-index: 200; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .helper-text { font-size: 12px; color: #64748b; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div id="view-container"></div>
<div id="guide-msg">é…ç½®ãƒ¢ãƒ¼ãƒ‰: æŒ‡ã‚’é›¢ã™ã¨æ±ºå®š</div>

<div class="view-controls">
    <button class="v-btn" onclick="setView('3d')" title="3D">ğŸ§Š</button>
    <button class="v-btn" onclick="setView('2d')" title="å¹³é¢">ğŸ“‹</button>
    <button class="v-btn" onclick="resetCamera()" title="ãƒªã‚»ãƒƒãƒˆ">ğŸ”„</button>
</div>

<div id="ui-panel">
    <div class="panel-toggle" onclick="togglePanel()"><div class="handle-bar"></div></div>
    <div class="tabs">
        <div class="tab active" onclick="tab(0)">ğŸ  éƒ¨å±‹</div>
        <div class="tab" onclick="tab(1)">ğŸ›‹ï¸ å®¶å…·è¿½åŠ </div>
        <div class="tab" id="tab-storage" onclick="tab(2)">ğŸ“¦ åç´ç®¡ç†</div>
    </div>

    <div class="content-scroll">
        <div id="sec-0" class="section active">
            <div class="card">
                <label>éƒ¨å±‹ã®ã‚µã‚¤ã‚º (å¹… x å¥¥è¡Œ cm)</label>
                <div class="grid-row">
                    <input type="number" id="room-w" value="300" placeholder="å¹…">
                    <input type="number" id="room-d" value="300" placeholder="å¥¥è¡Œ">
                    <button class="btn-sub" onclick="updateRoom()">é©ç”¨</button>
                </div>
                <label>åºŠã®æè³ª</label>
                <select id="floor-mat" onchange="updateRoom()">
                    <option value="0x334155">ãƒ¢ãƒ€ãƒ³(ã‚°ãƒ¬ãƒ¼)</option>
                    <option value="0x78350f">ãƒ•ãƒ­ãƒ¼ãƒªãƒ³ã‚°(æœ¨ç›®)</option>
                    <option value="0xecfdf5">å¤§ç†çŸ³é¢¨ã‚¿ã‚¤ãƒ«</option>
                    <option value="0x1e293b">ãƒ€ãƒ¼ã‚¯(ã‚«ãƒ¼ãƒšãƒƒãƒˆ)</option>
                </select>
            </div>
            <p class="helper-text">â€» 1ãƒã‚¹ã¯ 50cm x 50cm ã§ã™</p>
        </div>

        <div id="sec-1" class="section">
            <div class="card">
                <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
                <select id="f-preset" onchange="applyFPreset()" style="margin-bottom:15px;">
                    <option value="box">ã‚«ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹(3æ®µ)</option>
                    <option value="shelf">å¤§å®¹é‡ã‚³ãƒŸãƒƒã‚¯æ£š</option>
                    <option value="case">ã‚¢ã‚¯ãƒªãƒ«ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚±ãƒ¼ã‚¹</option>
                    <option value="desk">ã‚²ãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ã‚¹ã‚¯</option>
                </select>
                <div class="grid-row">
                    <div><label>å¹…</label><input type="number" id="f-w" value="40"></div>
                    <div><label>é«˜ã•</label><input type="number" id="f-h" value="90"></div>
                    <div><label>å¥¥è¡Œ</label><input type="number" id="f-d" value="30"></div>
                </div>
                <div class="grid-row">
                    <div><label>æ®µæ•°</label><input type="number" id="f-step" value="3"></div>
                    <div><label>è‰²</label><input type="color" id="f-c" value="#e2e8f0"></div>
                    <div style="display:flex; align-items:flex-end;"><button class="btn-main" onclick="spawnFurniture()">è¿½åŠ </button></div>
                </div>
            </div>
        </div>

        <div id="sec-2" class="section">
            <div id="storage-editor" style="display:none;">
                <div class="card" style="border: 1px solid var(--accent);">
                    <div id="target-name" style="font-weight:bold; color:var(--accent); font-size:16px; margin-bottom:12px;">å®¶å…·ã‚’é¸æŠä¸­</div>
                    <div class="action-bar">
                        <button class="btn-sub" style="flex:1" onclick="rotateFurniture()">â†» 90åº¦å›è»¢</button>
                        <button class="btn-danger" onclick="deleteFurniture()">ã‚´ãƒŸç®±ã¸</button>
                    </div>
                </div>

                <div class="card">
                    <label>ã‚°ãƒƒã‚ºã‚’åç´ã™ã‚‹</label>
                    <select id="item-preset" onchange="applyItemPreset()" style="margin-bottom:12px;">
                        <option value="manga">ğŸ“š å˜è¡Œæœ¬/ãƒ©ãƒãƒ™</option>
                        <option value="file">ğŸ“„ ã‚¯ãƒªã‚¢ãƒ•ã‚¡ã‚¤ãƒ«</option>
                        <option value="clearbox">ğŸ“¦ åç´ãƒœãƒƒã‚¯ã‚¹</option>
                        <option value="custom">âœ¨ ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ã‚º</option>
                    </select>
                    <input type="text" id="i-label" placeholder="åå‰ (ä¾‹: æ¨ã—ã®ã‚¢ã‚¯ã‚¹ã‚¿)" style="margin-bottom:12px;">
                    <div class="grid-row">
                        <div><label>å¹…</label><input type="number" id="i-w" value="11"></div>
                        <div><label>é«˜ã•</label><input type="number" id="i-h" value="17"></div>
                        <div><label>å¥¥è¡Œ</label><input type="number" id="i-d" value="2"></div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <label>åç´ã™ã‚‹æ®µ (1 = æœ€ä¸‹æ®µ)</label>
                        <input type="number" id="i-step-idx" value="1" min="1">
                    </div>
                    <button class="btn-main" style="background:var(--sub); color:white;" onclick="addItemToFurniture()">ã“ã®æ®µã«åç´</button>
                </div>
                <div id="item-list"></div>
            </div>
            <div id="storage-msg" style="text-align:center; opacity:0.5; padding:60px 20px; border:2px dashed #334155; border-radius:20px;">
                é…ç½®ã—ãŸå®¶å…·ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨<br>ä¸­èº«ã®ç®¡ç†ãŒã§ãã¾ã™
            </div>
        </div>
    </div>
</div>

<script>
let scene, camera, renderer, controls, raycaster, mouse;
let roomGroup, furnitureList = [];
let selectedFurniture = null;

init();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020617);

    camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 5000);
    camera.position.set(400, 450, 400);

    renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    document.getElementById('view-container').appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.maxPolarAngle = Math.PI / 2.1;
    controls.minDistance = 100;
    controls.maxDistance = 2000;

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambientLight);
    
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.4);
    dirLight.position.set(200, 500, 200);
    dirLight.castShadow = true;
    scene.add(dirLight);

    roomGroup = new THREE.Group();
    scene.add(roomGroup);

    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();

    updateRoom();
    window.addEventListener('resize', onResize);
    renderer.domElement.addEventListener('pointerdown', onPointerDown);
}

function togglePanel() {
    document.getElementById('ui-panel').classList.toggle('collapsed');
}

function tab(idx) {
    document.querySelectorAll('.section').forEach((s, i) => s.classList.toggle('active', i === idx));
    document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
    if(idx !== 2) deselectFurniture();
}

function setView(mode) {
    if(mode === '2d') {
        camera.position.set(0, 800, 0);
        controls.enableRotate = false;
    } else {
        camera.position.set(400, 450, 400);
        controls.enableRotate = true;
    }
    controls.target.set(0,0,0);
}

function resetCamera() {
    controls.reset();
    camera.position.set(400, 450, 400);
    controls.target.set(0,0,0);
}

function updateRoom() {
    roomGroup.clear();
    const w = parseFloat(document.getElementById('room-w').value) || 300;
    const d = parseFloat(document.getElementById('room-d').value) || 300;
    const col = parseInt(document.getElementById('floor-mat').value);
    
    const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(w, d),
        new THREE.MeshPhongMaterial({ color: col, side: THREE.DoubleSide })
    );
    floor.rotation.x = -Math.PI/2;
    floor.receiveShadow = true;
    roomGroup.add(floor);

    const grid = new THREE.GridHelper(Math.max(w,d), Math.max(w,d)/50, 0x475569, 0x334155);
    grid.position.y = 0.5;
    roomGroup.add(grid);

    // åŠé€æ˜ã®å£ï¼ˆå¥¥å´2æšã®ã¿ï¼‰
    const wallMat = new THREE.MeshPhongMaterial({ color: 0x1e293b, transparent: true, opacity: 0.15 });
    const wall1 = new THREE.Mesh(new THREE.BoxGeometry(w, 240, 2), wallMat);
    wall1.position.set(0, 120, -d/2);
    roomGroup.add(wall1);
    const wall2 = new THREE.Mesh(new THREE.BoxGeometry(2, 240, d), wallMat);
    wall2.position.set(-w/2, 120, 0);
    roomGroup.add(wall2);
}

function spawnFurniture() {
    const w = parseFloat(document.getElementById('f-w').value);
    const h = parseFloat(document.getElementById('f-h').value);
    const d = parseFloat(document.getElementById('f-d').value);
    const steps = parseInt(document.getElementById('f-step').value);
    const col = document.getElementById('f-c').value;

    const group = new THREE.Group();
    const mat = new THREE.MeshPhongMaterial({ color: col });
    const thick = 2;
    
    // å¤–æ ï¼ˆåº•ãƒ»å¤©ãƒ»å·¦å³ãƒ»èƒŒï¼‰
    const parts = [
        { s: [w, thick, d], p: [0, -h/2+thick/2, 0] }, // åº•
        { s: [w, thick, d], p: [0, h/2-thick/2, 0] }, // å¤©
        { s: [thick, h, d], p: [-w/2+thick/2, 0, 0] }, // å·¦
        { s: [thick, h, d], p: [w/2-thick/2, 0, 0] }, // å³
        { s: [w, h, 1], p: [0, 0, -d/2+0.5] } // èƒŒ
    ];

    parts.forEach(p => {
        const m = new THREE.Mesh(new THREE.BoxGeometry(...p.s), mat);
        m.position.set(...p.p);
        m.castShadow = true; m.receiveShadow = true;
        group.add(m);
    });

    const stepH = (h - (thick * (steps + 1))) / steps;
    for(let i=1; i < steps; i++) {
        const shelf = new THREE.Mesh(new THREE.BoxGeometry(w-thick*2, thick, d-thick), mat);
        shelf.position.y = -h/2 + thick + (stepH + thick) * i;
        group.add(shelf);
    }

    group.position.set(0, h/2 + 1, 0);
    group.userData = { type: 'furniture', items: [], h, w, d, steps, stepH, thick };
    scene.add(group);
    furnitureList.push(group);
    
    selectFurniture(group);
    tab(2);
    togglePanel(); // é…ç½®ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã«ä¸€ç¬é–‰ã˜ã‚‹
    setTimeout(() => document.getElementById('ui-panel').classList.remove('collapsed'), 1000);
}

function onPointerDown(e) {
    if (e.target.tagName !== 'CANVAS') return;
    
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = (e.clientX / rect.width) * 2 - 1;
    mouse.y = -(e.clientY / rect.height) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(furnitureList, true);

    if (intersects.length > 0) {
        let obj = intersects[0].object;
        while(obj.parent && obj.userData.type !== 'furniture') obj = obj.parent;
        
        selectFurniture(obj);
        document.getElementById('guide-msg').style.display = 'block';

        const move = (me) => {
            const mx = (me.clientX / rect.width) * 2 - 1;
            const my = -(me.clientY / rect.height) * 2 + 1;
            raycaster.setFromCamera({x:mx, y:my}, camera);
            const hit = new THREE.Vector3();
            raycaster.ray.intersectPlane(new THREE.Plane(new THREE.Vector3(0,1,0), 0), hit);
            
            // 5cmé–“éš”ã§ã‚¹ãƒŠãƒƒãƒ—
            obj.position.x = Math.round(hit.x / 5) * 5;
            obj.position.z = Math.round(hit.z / 5) * 5;
        };

        const up = () => {
            window.removeEventListener('pointermove', move);
            document.getElementById('guide-msg').style.display = 'none';
            controls.enabled = true;
        };

        controls.enabled = false;
        window.addEventListener('pointermove', move);
        window.addEventListener('pointerup', up, {once:true});
    }
}

function selectFurniture(obj) {
    deselectFurniture();
    selectedFurniture = obj;
    selectedFurniture.traverse(n => {
        if(n.isMesh) {
            n.material.emissive = new THREE.Color(0x222222);
        }
    });
    
    document.getElementById('storage-editor').style.display = 'block';
    document.getElementById('storage-msg').style.display = 'none';
    document.getElementById('target-name').innerText = `ç·¨é›†ä¸­ã®å®¶å…· (${obj.userData.w}x${obj.userData.h})`;
    document.getElementById('i-step-idx').max = obj.userData.steps;
    updateItemList();
}

function deselectFurniture() {
    if(selectedFurniture) {
        selectedFurniture.traverse(n => {
            if(n.isMesh) n.material.emissive = new THREE.Color(0x000000);
        });
    }
    selectedFurniture = null;
}

function rotateFurniture() {
    if(selectedFurniture) selectedFurniture.rotation.y += Math.PI / 2;
}

function deleteFurniture() {
    if(!selectedFurniture) return;
    if(!confirm("ã“ã®å®¶å…·ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    scene.remove(selectedFurniture);
    furnitureList = furnitureList.filter(f => f !== selectedFurniture);
    selectedFurniture = null;
    document.getElementById('storage-editor').style.display = 'none';
    document.getElementById('storage-msg').style.display = 'block';
}

function addItemToFurniture() {
    if(!selectedFurniture) return;
    const label = document.getElementById('i-label').value || "ã‚°ãƒƒã‚º";
    const iw = parseFloat(document.getElementById('i-w').value);
    const ih = parseFloat(document.getElementById('i-h').value);
    const id = parseFloat(document.getElementById('i-d').value);
    const stepIdx = parseInt(document.getElementById('i-step-idx').value) - 1;

    const itemMesh = new THREE.Mesh(
        new THREE.BoxGeometry(iw, ih, id),
        new THREE.MeshPhongMaterial({ color: 0xf472b6 })
    );

    // é…ç½®è¨ˆç®—: æŒ‡å®šã—ãŸæ®µã®åºŠã‹ã‚‰ã®é«˜ã•
    const { stepH, thick, h, w, d } = selectedFurniture.userData;
    const posY = -h/2 + thick + (stepH + thick) * stepIdx + ih/2;
    
    // æ¨ªä¸¦ã³ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆ: è¿½åŠ ã•ã‚Œã‚‹ã”ã¨ã«å°‘ã—ãšã¤æ¨ªã«ãšã‚‰ã™ï¼‰
    const offset = (selectedFurniture.userData.items.filter(i => i.step === stepIdx).length * (iw + 1));
    const posX = -w/2 + thick + iw/2 + (offset % (w - thick*2));
    
    itemMesh.position.set(posX, posY, 0);
    selectedFurniture.add(itemMesh);
    
    selectedFurniture.userData.items.push({ name: label, mesh: itemMesh, step: stepIdx });
    updateItemList();
}

function updateItemList() {
    const container = document.getElementById('item-list');
    container.innerHTML = '<div style="margin:15px 0 5px; font-size:12px; font-weight:bold; color:#94a3b8;">åç´æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ </div>';
    if(selectedFurniture.userData.items.length === 0) {
        container.innerHTML += '<div style="font-size:12px; opacity:0.5;">ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
    }
    selectedFurniture.userData.items.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `
            <div>
                <div style="font-size:14px;">${item.name}</div>
                <div style="font-size:10px; opacity:0.6;">${item.step + 1}æ®µç›®</div>
            </div>
            <button class="btn-danger" style="padding:4px 8px;" onclick="removeItem(${idx})">å‰Šé™¤</button>
        `;
        container.appendChild(div);
    });
}

function removeItem(idx) {
    const item = selectedFurniture.userData.items[idx];
    selectedFurniture.remove(item.mesh);
    selectedFurniture.userData.items.splice(idx, 1);
    updateItemList();
}

function applyFPreset() {
    const sets = {
        box: [40, 90, 30, 3],
        shelf: [80, 180, 18, 6],
        case: [60, 150, 40, 4],
        desk: [120, 72, 60, 1]
    };
    const s = sets[document.getElementById('f-preset').value];
    ['f-w','f-h','f-d','f-step'].forEach((id, i) => document.getElementById(id).value = s[i]);
}

function applyItemPreset() {
    const sets = {
        manga: ["å˜è¡Œæœ¬", 11, 17, 2],
        file: ["A4ã‚¯ãƒªã‚¢ãƒ•ã‚¡ã‚¤ãƒ«", 22, 31, 1],
        clearbox: ["åç´BOX", 25, 15, 30],
        custom: ["ã‚°ãƒƒã‚º", 15, 10, 10]
    };
    const s = sets[document.getElementById('item-preset').value];
    document.getElementById('i-label').value = s[0];
    ['i-w','i-h','i-d'].forEach((id, i) => document.getElementById(id).value = s[i+1]);
}

function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}
</script>
</body>
</html>
