<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Grid Memo</title>
<style>
/* =========================
   Base Design (Dusty Pink)
========================= */
:root{
  --pink:#c48a9a;
  --pink-light:#e8c7cf;
  --pink-bg:#f6eef1;
  --border:#e2d6da;
  --text:#4a3f44;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  background:var(--pink-bg);
  color:var(--text);
  overflow:hidden;
  touch-action:manipulation;
}

/* =========================
   Header
========================= */
header{
  height:56px;
  background:var(--pink);
  color:white;
  display:flex;
  align-items:center;
  padding:0 10px;
  justify-content:space-between;
}
header input{
  background:transparent;
  border:none;
  color:white;
  font-size:16px;
  font-weight:600;
  width:120px;
}
header button{
  background:var(--pink-light);
  border:none;
  padding:6px 10px;
  border-radius:8px;
  font-size:14px;
  color:var(--text);
}

/* =========================
   Layout
========================= */
#app{
  position:absolute;
  top:56px;
  bottom:0;
  left:0;
  right:0;
  display:flex;
  flex-direction:column;
}

/* Fixed headers */
#columnHeaders{
  display:flex;
  background:white;
  border-bottom:1px solid var(--border);
}
#rowHeaders{
  background:white;
  border-right:1px solid var(--border);
}
.corner{
  width:80px;
  border-right:1px solid var(--border);
}
.colHeader,.rowHeader{
  width:160px;
  min-width:160px;
  font-size:14px;
  text-align:center;
  padding:6px 4px;
  border-right:1px solid var(--border);
  border-bottom:1px solid var(--border);
  background:white;
}

/* Scroll area */
#scrollWrapper{
  flex:1;
  display:flex;
  overflow:hidden;
}
#gridScroll{
  flex:1;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}
#gridContainer{
  transform-origin:0 0;
}

/* Grid */
.row{
  display:flex;
}
.cell{
  width:160px; /* approx 15 chars */
  min-height:40px;
  max-height:160px; /* approx 100 chars */
  padding:6px;
  font-size:16pt;
  border-right:1px solid var(--border);
  border-bottom:1px solid var(--border);
  overflow:hidden;
  word-break:break-word;
}

/* =========================
   Long Text Editor
========================= */
#editorOverlay{
  position:fixed;
  left:0;
  right:0;
  bottom:-100%;
  height:100%;
  background:white;
  display:flex;
  flex-direction:column;
  transition:bottom .3s ease;
}
#editorOverlay.active{
  bottom:0;
}
#editorHeader{
  height:56px;
  background:var(--pink);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 12px;
  color:white;
}
#editorOverlay textarea{
  flex:1;
  border:none;
  padding:16px;
  font-size:16pt;
  outline:none;
  resize:none;
}
#charCount{
  font-size:14px;
}
</style>
</head>
<body>

<header>
  <div>
    <input id="sheetName" value="Sheet 1">
  </div>
  <div>
    <button id="addSheet">＋</button>
    <button id="deleteSheet">－</button>
  </div>
</header>

<div id="app">
  <div id="columnHeaders">
    <div class="corner"></div>
  </div>
  <div id="scrollWrapper">
    <div id="rowHeaders"></div>
    <div id="gridScroll">
      <div id="gridContainer"></div>
    </div>
  </div>
</div>

<!-- Long Text Editor -->
<div id="editorOverlay">
  <div id="editorHeader">
    <div>メモ</div>
    <div id="charCount">0</div>
    <button id="closeEditor">保存</button>
  </div>
  <textarea id="editorTextarea"></textarea>
</div>

<script>
/* =========================
   Constants
========================= */
const ROWS=50;
const COLS=12;
let currentSheetId=null;
let scale=1;
let db;

/* =========================
   IndexedDB Setup
========================= */
const request=indexedDB.open("GridMemoDB",1);
request.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("sheets",{keyPath:"id",autoIncrement:true});
};
request.onsuccess=e=>{
  db=e.target.result;
  init();
};

/* =========================
   Initialize
========================= */
function init(){
  loadSheets();
  createHeaders();
  setupPinch();
}

/* =========================
   Sheet Management
========================= */
function loadSheets(){
  const tx=db.transaction("sheets","readonly");
  const store=tx.objectStore("sheets");
  const req=store.getAll();
  req.onsuccess=()=>{
    if(req.result.length===0){
      createSheet("Sheet 1");
    }else{
      loadSheet(req.result[0]);
    }
  };
}

function createSheet(name){
  const tx=db.transaction("sheets","readwrite");
  tx.objectStore("sheets").add({name,cells:{}});
  tx.oncomplete=loadSheets;
}

function loadSheet(sheet){
  currentSheetId=sheet.id;
  document.getElementById("sheetName").value=sheet.name;
  renderGrid(sheet.cells);
}

function deleteCurrentSheet(){
  if(!currentSheetId) return;
  const tx=db.transaction("sheets","readwrite");
  tx.objectStore("sheets").delete(currentSheetId);
  tx.oncomplete=loadSheets;
}

document.getElementById("addSheet").onclick=()=>{
  createSheet("New Sheet");
};
document.getElementById("deleteSheet").onclick=deleteCurrentSheet;

document.getElementById("sheetName").onchange=e=>{
  const tx=db.transaction("sheets","readwrite");
  const store=tx.objectStore("sheets");
  const req=store.get(currentSheetId);
  req.onsuccess=()=>{
    const data=req.result;
    data.name=e.target.value;
    store.put(data);
  };
};

/* =========================
   Grid Rendering
========================= */
function createHeaders(){
  const colH=document.getElementById("columnHeaders");
  for(let c=0;c<COLS;c++){
    const div=document.createElement("div");
    div.className="colHeader";
    div.textContent=String.fromCharCode(65+c);
    colH.appendChild(div);
  }
  const rowH=document.getElementById("rowHeaders");
  for(let r=0;r<ROWS;r++){
    const div=document.createElement("div");
    div.className="rowHeader";
    div.textContent=r+1;
    rowH.appendChild(div);
  }
}

function renderGrid(cells){
  const container=document.getElementById("gridContainer");
  container.innerHTML="";
  for(let r=0;r<ROWS;r++){
    const row=document.createElement("div");
    row.className="row";
    for(let c=0;c<COLS;c++){
      const key=r+"-"+c;
      const cell=document.createElement("div");
      cell.className="cell";
      cell.textContent=cells[key]||"";
      cell.onclick=()=>openEditor(r,c,cell.textContent);
      row.appendChild(cell);
    }
    container.appendChild(row);
  }
}

/* =========================
   Cell Editing
========================= */
let editTarget=null;
function openEditor(r,c,value){
  editTarget={r,c};
  const overlay=document.getElementById("editorOverlay");
  const textarea=document.getElementById("editorTextarea");
  textarea.value=value||"";
  document.getElementById("charCount").textContent=textarea.value.length;
  overlay.classList.add("active");
  textarea.focus();
}

document.getElementById("editorTextarea").oninput=e=>{
  document.getElementById("charCount").textContent=e.target.value.length;
};

document.getElementById("closeEditor").onclick=()=>{
  const value=document.getElementById("editorTextarea").value;
  saveCell(editTarget.r,editTarget.c,value);
  document.getElementById("editorOverlay").classList.remove("active");
};

function saveCell(r,c,value){
  const tx=db.transaction("sheets","readwrite");
  const store=tx.objectStore("sheets");
  const req=store.get(currentSheetId);
  req.onsuccess=()=>{
    const data=req.result;
    data.cells[r+"-"+c]=value;
    store.put(data);
    loadSheet(data);
  };
}

/* =========================
   Pinch Zoom (Grid Only)
========================= */
function setupPinch(){
  const grid=document.getElementById("gridContainer");
  let startDist=0;
  let startScale=1;

  grid.addEventListener("touchstart",e=>{
    if(e.touches.length===2){
      startDist=getDist(e);
      startScale=scale;
    }
  },{passive:false});

  grid.addEventListener("touchmove",e=>{
    if(e.touches.length===2){
      e.preventDefault();
      const newDist=getDist(e);
      scale=Math.min(2,Math.max(0.3,startScale*(newDist/startDist)));
      grid.style.transform="scale("+scale+")";
    }
  },{passive:false});
}

function getDist(e){
  const dx=e.touches[0].clientX-e.touches[1].clientX;
  const dy=e.touches[0].clientY-e.touches[1].clientY;
  return Math.sqrt(dx*dx+dy*dy);
}
</script>
</body>
</html>
