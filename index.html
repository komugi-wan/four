<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTK-Room Designer v6.5 Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root { 
            --accent: #4ade80; --accent-dark: #064e3b;
            --sub: #f472b6; --bg: #020617; 
            --panel: rgba(15, 23, 42, 0.9); --text: #f8fafc; 
            --danger: #ef4444; --card: rgba(255,255,255,0.03);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        body { 
            margin: 0; overflow: hidden; position: fixed; width: 100%; height: 100%;
            font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); 
            touch-action: none; -webkit-user-select: none;
        }
        
        #view-container { height: 100%; width: 100%; outline: none; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        #status-bar {
            position: fixed; top: 15px; left: 15px; background: rgba(0,0,0,0.7);
            padding: 8px 15px; border-radius: 50px; font-size: 10px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px); z-index: 60; display: flex; align-items: center; gap: 8px; font-weight: 700;
        }
        .dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }

        /* å³å´ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ */
        .v-controls {
            position: fixed; top: 15px; right: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 50;
        }
        .v-btn { 
            background: rgba(30, 41, 59, 0.8); color: white; border: 1px solid rgba(255,255,255,0.1); 
            width: 52px; height: 52px; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); font-weight: bold; font-size: 10px; transition: 0.2s;
        }
        .v-btn.active { background: var(--accent); color: var(--accent-dark); border-color: var(--accent); }
        .v-btn i { font-size: 16px; margin-bottom: 2px; }

        /* UIãƒ‘ãƒãƒ« */
        #ui-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 75vh;
            background: var(--panel); border-top: 1px solid rgba(255,255,255,0.15);
            border-radius: 32px 32px 0 0; z-index: 100; 
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(20px); display: flex; flex-direction: column;
            padding-bottom: var(--safe-bottom);
        }
        #ui-panel.collapsed { transform: translateY(calc(75vh - 70px)); }
        #ui-panel.half { transform: translateY(35vh); }
        
        .panel-toggle {
            width: 100%; height: 70px; display: flex; flex-direction: column; justify-content: center; align-items: center; flex-shrink: 0;
        }
        .handle-bar { width: 36px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 10px; margin-bottom: 10px; }

        .tabs { display: flex; padding: 0 16px; gap: 10px; margin-bottom: 15px; }
        .tab { 
            flex: 1; padding: 10px; text-align: center; font-size: 11px; font-weight: 800;
            border-radius: 12px; background: rgba(255,255,255,0.03); color: #64748b; transition: 0.2s;
        }
        .tab.active { background: #334155; color: var(--accent); }

        .content-scroll { flex: 1; overflow-y: auto; padding: 0 20px 40px 20px; }
        .card { background: var(--card); padding: 18px; border-radius: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .section { display: none; }
        .section.active { display: block; }

        .grid-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px; }
        label { display: block; font-size: 10px; color: #94a3b8; margin-bottom: 6px; font-weight: 700; }
        input, select { 
            width: 100%; background: #1e293b; border: 1px solid #334155; color: white; 
            padding: 12px; border-radius: 12px; font-size: 14px; box-sizing: border-box;
        }
        
        .btn-main { 
            background: var(--accent); color: var(--accent-dark); border: none; width: 100%; padding: 18px; 
            border-radius: 18px; font-weight: 900; font-size: 14px; margin-top: 10px;
        }
        .btn-sub { background: #334155; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 11px; font-weight: 700; }

        .item-row { 
            background: rgba(255,255,255,0.03); padding: 10px 15px; border-radius: 12px; 
            margin-top: 8px; display: flex; justify-content: space-between; align-items: center;
            border-left: 3px solid var(--sub);
        }

        /* è£œåŠ©ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #mode-overlay {
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: var(--accent-dark); padding: 6px 15px;
            border-radius: 20px; font-size: 11px; font-weight: 900; z-index: 150;
            display: none; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="view-container"></div>
<div id="status-bar"><div class="dot"></div><span id="status-text">SYSTEM ACTIVE</span></div>
<div id="mode-overlay">MOVING...</div>

<div class="v-controls">
    <button class="v-btn" id="btn-3d" onclick="changeView('3d')"><span>3D</span></button>
    <button class="v-btn" id="btn-2d" onclick="changeView('2d')"><span>2D</span></button>
    <button class="v-btn" id="btn-elev" onclick="changeView('elev')"><span>ELEV</span></button>
    <button class="v-btn" style="margin-top:20px; background:var(--accent-dark)" onclick="saveData()">SAVE</button>
</div>

<div id="ui-panel" class="collapsed">
    <div class="panel-toggle" onclick="cyclePanel()">
        <div class="handle-bar"></div>
        <div style="font-size: 10px; font-weight: 900; color: #4ade80; letter-spacing: 0.1em;">OTK-ROOM DESIGNER v6.5</div>
    </div>
    
    <div class="tabs">
        <div class="tab active" onclick="tab(0)">ROOM</div>
        <div class="tab" onclick="tab(1)">CATALOG</div>
        <div class="tab" id="tab-edit" onclick="tab(2)">EDIT</div>
    </div>

    <div class="content-scroll">
        <div id="sec-0" class="section active">
            <div class="card">
                <label>éƒ¨å±‹ã‚µã‚¤ã‚º (cm)</label>
                <div class="grid-row">
                    <div><label>å¹…</label><input type="number" id="room-w" value="300" onchange="updateRoom()"></div>
                    <div><label>å¥¥è¡Œ</label><input type="number" id="room-d" value="300" onchange="updateRoom()"></div>
                    <div><label>åºŠè‰²</label>
                        <select id="floor-mat" onchange="updateRoom()">
                            <option value="0x0f172a">Dark</option>
                            <option value="0x334155">Slate</option>
                            <option value="0x451a03">Wood</option>
                        </select>
                    </div>
                </div>
            </div>
            <button class="btn-sub" style="width:100%; color:var(--danger); background:rgba(239,68,68,0.05)" onclick="clearAll()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div id="sec-1" class="section">
            <div class="card">
                <label>å®¶å…·ã®ç¨®é¡</label>
                <select id="f-preset" onchange="applyFPreset()" style="margin-bottom:15px;">
                    <option value="box">ã‚«ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹ (3æ®µ)</option>
                    <option value="shelf">ãƒ–ãƒƒã‚¯ã‚·ã‚§ãƒ«ãƒ•</option>
                    <option value="case">ã‚¢ã‚¯ãƒªãƒ«ã‚·ãƒ§ãƒ¼ã‚±ãƒ¼ã‚¹</option>
                    <option value="desk">ãƒ‡ã‚¹ã‚¯</option>
                </select>
                <div class="grid-row">
                    <div><label>å¹…</label><input type="number" id="f-w" value="42"></div>
                    <div><label>é«˜</label><input type="number" id="f-h" value="90"></div>
                    <div><label>å¥¥</label><input type="number" id="f-d" value="30"></div>
                </div>
                <div class="grid-row">
                    <div><label>æ®µæ•°</label><input type="number" id="f-step" value="3"></div>
                    <div><label>è‰²</label><input type="color" id="f-c" value="#e2e8f0"></div>
                    <div><label>é€æ˜åº¦</label><input type="range" id="f-op" min="0.2" max="1" step="0.1" value="1"></div>
                </div>
                <button class="btn-main" onclick="spawnFurniture()">å®¶å…·ã‚’éƒ¨å±‹ã«é…ç½®</button>
            </div>
        </div>

        <div id="sec-2" class="section">
            <div id="storage-editor" style="display:none;">
                <div class="card">
                    <label>å®¶å…·ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å¤‰æ›´</label>
                    <div class="grid-row">
                        <div><label>å¹…</label><input type="number" id="edit-f-w" onchange="updateSelectedFurniture()"></div>
                        <div><label>é«˜</label><input type="number" id="edit-f-h" onchange="updateSelectedFurniture()"></div>
                        <div><label>å¥¥</label><input type="number" id="edit-f-d" onchange="updateSelectedFurniture()"></div>
                    </div>
                    <div class="grid-row">
                        <div><label>æ®µæ•°</label><input type="number" id="edit-f-step" onchange="updateSelectedFurniture()"></div>
                        <div><label>è‰²</label><input type="color" id="edit-f-c" onchange="updateSelectedFurniture()"></div>
                        <div><label>é€æ˜</label><input type="range" id="edit-f-op" min="0.2" max="1" step="0.1" onchange="updateSelectedFurniture()"></div>
                    </div>
                </div>

                <div class="card" style="border-color: var(--accent);">
                    <div id="target-name" style="font-weight:900; color:var(--accent); margin-bottom:12px; font-size:12px;">é¸æŠä¸­</div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-sub" style="flex:1" onclick="rotateFurniture()">90Â°å›è»¢</button>
                        <button class="btn-sub" style="flex:1; color:var(--danger)" onclick="deleteFurniture()">å‰Šé™¤</button>
                    </div>
                </div>

                <div class="card">
                    <label>ã‚°ãƒƒã‚ºã‚’è¿½åŠ  (ç«‹é¢è¡¨ç¤ºæ¨å¥¨)</label>
                    <select id="item-preset" onchange="applyItemPreset()" style="margin-bottom:15px;">
                        <option value="manga">ğŸ“š ã‚³ãƒŸãƒƒã‚¯/æœ¬</option>
                        <option value="figure">ğŸ§¸ ãƒ•ã‚£ã‚®ãƒ¥ã‚¢/ã‚¢ã‚¯ã‚¹ã‚¿</option>
                        <option value="file">ğŸ“„ ã‚¯ãƒªã‚¢ãƒ•ã‚¡ã‚¤ãƒ«</option>
                    </select>
                    <div class="grid-row" style="grid-template-columns: 2fr 1fr;">
                        <div><label>ãƒ©ãƒ™ãƒ«</label><input type="text" id="i-label" placeholder="æ¨ã—ã®åå‰ãªã©"></div>
                        <div><label>æ®µ</label><input type="number" id="i-step-idx" value="1" min="1"></div>
                    </div>
                    <div class="grid-row">
                        <div><label>å¹…(cm)</label><input type="number" id="i-w" value="11.3"></div>
                        <div><label>é«˜ã•(cm)</label><input type="number" id="i-h" value="17.6"></div>
                        <div><label>å‰å¾Œä½ç½®</label><input type="range" id="i-z-off" min="0.1" max="0.9" step="0.1" value="0.5"></div>
                    </div>
                    <button class="btn-main" style="background: var(--sub); color:white;" onclick="addItemToFurniture()">ã“ã®ä½ç½®ã«è¿½åŠ </button>
                </div>
                <div id="item-list"></div>
            </div>
            
            <div id="storage-msg" style="text-align:center; opacity:0.5; padding:60px 20px; border:2px dashed rgba(255,255,255,0.1); border-radius:24px; font-size: 12px;">
                å®¶å…·ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç·¨é›†ã‚’é–‹å§‹
            </div>
        </div>
    </div>
</div>

<script>
let scene, camera, renderer, controls, raycaster, mouse;
let furnitureList = [];
let selectedFurniture = null;
let roomFloor;
let currentViewMode = '3d';

init();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020617);

    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 5000);
    camera.position.set(400, 500, 400);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    document.getElementById('view-container').appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.1;
    controls.maxPolarAngle = Math.PI / 2.1;

    const ambient = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambient);
    
    const sun = new THREE.DirectionalLight(0xffffff, 0.6);
    sun.position.set(200, 500, 200);
    sun.castShadow = true;
    scene.add(sun);

    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();

    updateRoom();
    loadData();

    window.addEventListener('resize', onResize);
    renderer.domElement.addEventListener('pointerdown', onPointerDown, {passive: false});
}

function cyclePanel() {
    const p = document.getElementById('ui-panel');
    if (p.classList.contains('collapsed')) p.className = 'half';
    else if (p.classList.contains('half')) p.className = '';
    else p.className = 'collapsed';
}

function tab(idx) {
    document.querySelectorAll('.section').forEach((s, i) => s.classList.toggle('active', i === idx));
    document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
}

function changeView(mode) {
    currentViewMode = mode;
    document.querySelectorAll('.v-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-${mode}`).classList.add('active');

    if(mode === '2d') {
        controls.enabled = true;
        camera.position.set(0, 700, 0);
        controls.target.set(0,0,0);
    } else if (mode === 'elev' && selectedFurniture) {
        const fPos = selectedFurniture.position;
        const offset = new THREE.Vector3(0, 0, 300).applyAxisAngle(new THREE.Vector3(0,1,0), selectedFurniture.rotation.y);
        camera.position.set(fPos.x + offset.x, fPos.y, fPos.z + offset.z);
        controls.target.set(fPos.x, fPos.y, fPos.z);
        controls.enabled = false;
    } else {
        controls.enabled = true;
        camera.position.set(400, 400, 400);
        controls.target.set(0,0,0);
    }
}

function updateRoom() {
    if(roomFloor) scene.remove(roomFloor);
    const w = parseFloat(document.getElementById('room-w').value) || 300;
    const d = parseFloat(document.getElementById('room-d').value) || 300;
    const col = parseInt(document.getElementById('floor-mat').value);
    
    const group = new THREE.Group();
    const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(w, d),
        new THREE.MeshStandardMaterial({ color: col, roughness: 0.9 })
    );
    floor.rotation.x = -Math.PI/2;
    floor.receiveShadow = true;
    group.add(floor);

    const grid = new THREE.GridHelper(Math.max(w,d), 20, 0x4ade80, 0x1e293b);
    grid.position.y = 0.1;
    grid.material.opacity = 0.2;
    grid.material.transparent = true;
    group.add(grid);

    roomFloor = group;
    scene.add(roomFloor);
    
    // éƒ¨å±‹ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«æ—¢å­˜ã®å®¶å…·ã‚’æŠ¼ã—æˆ»ã™
    furnitureList.forEach(f => {
        const clamped = clampPosition(f.position.x, f.position.z, f.userData.w, f.userData.d, f.rotation.y);
        f.position.x = clamped.x;
        f.position.z = clamped.z;
    });
}

// å®¶å…·ãŒåºŠã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«åº§æ¨™ã‚’åˆ¶é™ã™ã‚‹é–¢æ•°
function clampPosition(x, z, fw, fd, rot) {
    const rw = parseFloat(document.getElementById('room-w').value) || 300;
    const rd = parseFloat(document.getElementById('room-d').value) || 300;
    
    // å›è»¢ã‚’è€ƒæ…®ã—ãŸã‚µã‚¤ã‚ºï¼ˆç°¡æ˜“è¨ˆç®—ï¼‰
    const isRotated = (Math.round(rot / (Math.PI/2)) % 2 !== 0);
    const actualW = isRotated ? fd : fw;
    const actualD = isRotated ? fw : fd;

    const limitX = (rw - actualW) / 2;
    const limitZ = (rd - actualD) / 2;

    return {
        x: Math.max(-limitX, Math.min(limitX, x)),
        z: Math.max(-limitZ, Math.min(limitZ, z))
    };
}

function spawnFurniture(data = null) {
    const config = data || {
        w: parseFloat(document.getElementById('f-w').value),
        h: parseFloat(document.getElementById('f-h').value),
        d: parseFloat(document.getElementById('f-d').value),
        steps: parseInt(document.getElementById('f-step').value),
        color: document.getElementById('f-c').value,
        opacity: parseFloat(document.getElementById('f-op').value),
        pos: [0, 0, 0], rot: 0, items: []
    };

    const group = new THREE.Group();
    const mat = new THREE.MeshStandardMaterial({ 
        color: config.color, transparent: config.opacity < 1, opacity: config.opacity, roughness: 0.6
    });
    
    const t = 1.8; 
    const parts = [
        {s:[t, config.h, config.d], p:[-config.w/2 + t/2, 0, 0]},
        {s:[t, config.h, config.d], p:[config.w/2 - t/2, 0, 0]},
        {s:[config.w, t, config.d], p:[0, config.h/2 - t/2, 0]},
        {s:[config.w, config.h, 0.5], p:[0, 0, -config.d/2 + 0.25]}
    ];

    parts.forEach(p => {
        const m = new THREE.Mesh(new THREE.BoxGeometry(...p.s), mat);
        m.position.set(...p.p);
        m.castShadow = true; m.receiveShadow = true;
        group.add(m);
    });

    const stepH = (config.h - t*2) / Math.max(1, config.steps);
    for(let i=0; i<=config.steps; i++) {
        const p = new THREE.Mesh(new THREE.BoxGeometry(config.w - t*2, t, config.d - 1), mat);
        p.position.y = -config.h/2 + (stepH * i) + (i === 0 ? t/2 : 0);
        group.add(p);
    }

    group.userData = { type: 'furniture', items: [], ...config, stepH };
    
    // åˆæœŸé…ç½®ã®å¢ƒç•Œãƒã‚§ãƒƒã‚¯
    const clamped = clampPosition(config.pos[0], config.pos[2], config.w, config.d, config.rot);
    group.position.set(clamped.x, config.h/2, clamped.z);
    group.rotation.y = config.rot;
    
    scene.add(group);
    furnitureList.push(group);
    
    // ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆã‚°ãƒƒã‚ºï¼‰ã®å¾©å…ƒ
    config.items.forEach(item => addItemToFurniture(group, item));

    if(!data) { selectFurniture(group); tab(2); } 
    return group;
}

// é¸æŠä¸­ã®å®¶å…·ã®ã‚µã‚¤ã‚ºãƒ»è‰²ã‚’æ›´æ–°ã™ã‚‹
function updateSelectedFurniture() {
    if (!selectedFurniture) return;

    const oldData = selectedFurniture.userData;
    const newData = {
        ...oldData,
        w: parseFloat(document.getElementById('edit-f-w').value),
        h: parseFloat(document.getElementById('edit-f-h').value),
        d: parseFloat(document.getElementById('edit-f-d').value),
        steps: parseInt(document.getElementById('edit-f-step').value),
        color: document.getElementById('edit-f-c').value,
        opacity: parseFloat(document.getElementById('edit-f-op').value),
        pos: [selectedFurniture.position.x, 0, selectedFurniture.position.z],
        rot: selectedFurniture.rotation.y,
        // ã‚¢ã‚¤ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾å¼•ãç¶™ã
        items: oldData.items.map(i => ({...i, mesh: null})) 
    };

    // ä¸€æ—¦å‰Šé™¤ã—ã¦å†ç”Ÿæˆï¼ˆç°¡æ˜“çš„ãªå½¢çŠ¶æ›´æ–°æ–¹æ³•ï¼‰
    const idx = furnitureList.indexOf(selectedFurniture);
    scene.remove(selectedFurniture);
    furnitureList.splice(idx, 1);
    
    const newObj = spawnFurniture(newData);
    selectFurniture(newObj);
    saveData();
}

function onPointerDown(e) {
    if (e.button !== 0) return;
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = (e.clientX / rect.width) * 2 - 1;
    mouse.y = -(e.clientY / rect.height) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(furnitureList, true);

    if (intersects.length > 0) {
        let obj = intersects[0].object;
        while(obj.parent && obj.userData.type !== 'furniture') obj = obj.parent;
        
        selectFurniture(obj);
        if(currentViewMode === 'elev') return;

        const overlay = document.getElementById('mode-overlay');
        overlay.style.display = 'block';
        controls.enabled = false;

        const move = (me) => {
            const mx = (me.clientX / rect.width) * 2 - 1;
            const my = -(me.clientY / rect.height) * 2 + 1;
            raycaster.setFromCamera({x:mx, y:my}, camera);
            const hit = new THREE.Vector3();
            raycaster.ray.intersectPlane(new THREE.Plane(new THREE.Vector3(0,1,0), 0), hit);
            
            // å¢ƒç•Œåˆ¶é™ã‚’é©ç”¨ã—ãªãŒã‚‰ç§»å‹•
            const clamped = clampPosition(hit.x, hit.z, obj.userData.w, obj.userData.d, obj.rotation.y);
            obj.position.x = Math.round(clamped.x / 5) * 5;
            obj.position.z = Math.round(clamped.z / 5) * 5;
        };

        const up = () => {
            window.removeEventListener('pointermove', move);
            overlay.style.display = 'none';
            controls.enabled = true;
            saveData();
        };

        window.addEventListener('pointermove', move);
        window.addEventListener('pointerup', up, {once:true});
    }
}

function selectFurniture(obj) {
    furnitureList.forEach(f => {
        f.traverse(n => { if(n.isMesh) { n.material.emissive = new THREE.Color(0x000000); } });
    });
    selectedFurniture = obj;
    obj.traverse(n => { if(n.isMesh) { n.material.emissive = new THREE.Color(0x112211); } });
    
    document.getElementById('storage-editor').style.display = 'block';
    document.getElementById('storage-msg').style.display = 'none';
    document.getElementById('target-name').innerText = `é¸æŠä¸­: ${obj.userData.w}x${obj.userData.h}cm`;
    
    // ç·¨é›†ç”¨å…¥åŠ›æ¬„ã«ç¾åœ¨ã®å€¤ã‚’ã‚»ãƒƒãƒˆ
    document.getElementById('edit-f-w').value = obj.userData.w;
    document.getElementById('edit-f-h').value = obj.userData.h;
    document.getElementById('edit-f-d').value = obj.userData.d;
    document.getElementById('edit-f-step').value = obj.userData.steps;
    document.getElementById('edit-f-c').value = obj.userData.color;
    document.getElementById('edit-f-op').value = obj.userData.opacity;
    
    document.getElementById('i-step-idx').max = obj.userData.steps;
    updateItemList();
}

function rotateFurniture() {
    if(selectedFurniture) {
        const newRot = selectedFurniture.rotation.y + Math.PI / 2;
        // å›è»¢å¾Œã‚‚åºŠã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ä½ç½®èª¿æ•´
        const clamped = clampPosition(selectedFurniture.position.x, selectedFurniture.position.z, selectedFurniture.userData.w, selectedFurniture.userData.d, newRot);
        selectedFurniture.rotation.y = newRot;
        selectedFurniture.position.x = clamped.x;
        selectedFurniture.position.z = clamped.z;
        saveData();
    }
}

function deleteFurniture() {
    if(!selectedFurniture || !confirm("å®¶å…·ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    scene.remove(selectedFurniture);
    furnitureList = furnitureList.filter(f => f !== selectedFurniture);
    selectedFurniture = null;
    document.getElementById('storage-editor').style.display = 'none';
    document.getElementById('storage-msg').style.display = 'block';
    saveData();
}

function addItemToFurniture(target = null, savedItem = null) {
    const f = target || selectedFurniture;
    if(!f) return;

    const preset = document.getElementById('item-preset').value;
    const itemData = savedItem || {
        name: document.getElementById('i-label').value || "Goods",
        w: parseFloat(document.getElementById('i-w').value) || 10,
        h: parseFloat(document.getElementById('i-h').value) || 10,
        d: (preset === 'figure' ? 8 : 1.5),
        step: parseInt(document.getElementById('i-step-idx').value) - 1,
        zOff: parseFloat(document.getElementById('i-z-off').value),
        color: preset === 'figure' ? 0xffffff : `hsl(${Math.random() * 360}, 50%, 75%)`,
        opacity: preset === 'figure' ? 0.7 : 1
    };

    const itemMesh = new THREE.Mesh(
        new THREE.BoxGeometry(itemData.w, itemData.h, itemData.d),
        new THREE.MeshStandardMaterial({ color: itemData.color, transparent: itemData.opacity < 1, opacity: itemData.opacity })
    );

    const { stepH, h, w, d } = f.userData;
    const posY = -h/2 + (stepH * itemData.step) + itemData.h/2 + 2;
    const sameStepItems = f.userData.items.filter(i => i.step === itemData.step);
    const offsetX = sameStepItems.reduce((acc, cur) => acc + cur.w + 1, 0);
    const posX = -w/2 + 3 + offsetX + itemData.w/2;
    const posZ = (-d/2 + 3) + (d - 6) * itemData.zOff;
    
    // é…ç½®å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå†ç”Ÿæˆæ™‚ã¯ç„¡è¦–ï¼‰
    if (!savedItem && posX > w/2 - 3) { alert("ã“ã®æ®µã«ã¯ã‚‚ã†å…¥ã‚Šã¾ã›ã‚“"); return; }

    itemMesh.position.set(posX, posY, posZ);
    f.add(itemMesh);
    
    // å‚ç…§ã‚’ä¿æŒï¼ˆsavedItemãŒã‚ã‚‹å ´åˆã¯æ—¢å­˜é…åˆ—ã‚’æ›´æ–°ã›ãšã€meshã ã‘å…¥ã‚Œã‚‹ï¼‰
    if(savedItem) {
        savedItem.mesh = itemMesh;
    } else {
        f.userData.items.push({ ...itemData, mesh: itemMesh });
        updateItemList(); 
        saveData();
    }
}

function updateItemList() {
    const container = document.getElementById('item-list');
    container.innerHTML = '<label style="margin-top:20px">é…ç½®æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ </label>';
    if(!selectedFurniture) return;
    selectedFurniture.userData.items.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `<div><b>${item.name}</b><br><small>${item.step+1}æ®µç›®</small></div>
                         <button class="btn-sub" style="background:none; color:var(--danger)" onclick="removeItem(${idx})">âœ•</button>`;
        container.appendChild(div);
    });
}

function removeItem(idx) {
    const item = selectedFurniture.userData.items[idx];
    selectedFurniture.remove(item.mesh);
    selectedFurniture.userData.items.splice(idx, 1);
    updateItemList();
    saveData();
}

function applyFPreset() {
    const sets = { box: [42, 90, 30, 3, 1], shelf: [80, 180, 28, 6, 1], case: [60, 150, 40, 4, 0.4], desk: [120, 72, 60, 1, 1] };
    const s = sets[document.getElementById('f-preset').value];
    ['f-w','f-h','f-d','f-step','f-op'].forEach((id, i) => document.getElementById(id).value = s[i]);
}

function applyItemPreset() {
    const sets = { manga: ["ã‚³ãƒŸãƒƒã‚¯", 11.3, 17.6, 0.2], figure: ["ãƒ•ã‚£ã‚®ãƒ¥ã‚¢", 12, 18, 0.5], file: ["ãƒ•ã‚¡ã‚¤ãƒ«", 22, 31, 0.1] };
    const s = sets[document.getElementById('item-preset').value];
    ['i-label','i-w','i-h','i-z-off'].forEach((id, i) => document.getElementById(id).value = s[i]);
}

function saveData() {
    const data = {
        room: { w: document.getElementById('room-w').value, d: document.getElementById('room-d').value, mat: document.getElementById('floor-mat').value },
        furniture: furnitureList.map(f => ({
            w: f.userData.w, h: f.userData.h, d: f.userData.d, steps: f.userData.steps, 
            color: f.userData.color, opacity: f.userData.opacity,
            pos: [f.position.x, f.position.y, f.position.z], rot: f.rotation.y,
            items: f.userData.items.map(i => ({ name: i.name, w: i.w, h: i.h, d: i.d, step: i.step, zOff: i.zOff, color: i.color, opacity: i.opacity }))
        }))
    };
    localStorage.setItem('otk_room_v6', JSON.stringify(data));
    document.getElementById('status-text').innerText = "DATA SAVED";
    setTimeout(() => { document.getElementById('status-text').innerText = "SYSTEM ACTIVE"; }, 1500);
}

function loadData() {
    const raw = localStorage.getItem('otk_room_v6');
    if(!raw) return;
    const data = JSON.parse(raw);
    document.getElementById('room-w').value = data.room.w;
    document.getElementById('room-d').value = data.room.d;
    document.getElementById('floor-mat').value = data.room.mat;
    updateRoom();
    data.furniture.forEach(f => spawnFurniture(f));
}

function clearAll() {
    if(confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('otk_room_v6'); location.reload(); }
}

function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}
</script>
</body>
</html>
