<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.5, minimum-scale=0.1, maximum-scale=5.0, user-scalable=yes">
    <title>Professional Spreadsheet App</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f06595">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        :root {
            --header-bg: #f8f9fa;
            [cite_start]--border-color: #ddd; [cite: 2]
            --accent-color: #f06595;
            --accent-hover: #ffdeeb;
            --cell-width: 100px;
            --row-height: 32px;
            --tab-bg: #e8eaed;
        [cite_start]} [cite: 3]

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            color: #333; 
            overflow: hidden;
            /* 画面の揺れを抑えるための追加設定 */
            overscroll-behavior: none;
            /* 文字選択とズームの抑制を追加 */
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        [cite_start]} [cite: 6]
        .toolbar { background: #fff; padding: 12px; border-bottom: 1px solid var(--border-color); display: flex;
            gap: 10px; align-items: center; flex-wrap: wrap;
            [cite_start]box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 100; [cite: 7]
        }
        .color-palette { display: flex;
            [cite_start]gap: 4px; align-items: center; margin-left: 10px; padding-left: 10px; [cite: 8]
            border-left: 1px solid #ccc;
        }
        .color-swatch { width: 20px; height: 20px; border-radius: 3px;
            [cite_start]cursor: pointer; border: 1px solid #ddd; [cite: 9]
            transition: transform 0.1s; }
        .color-swatch:hover { transform: scale(1.2);
            [cite_start]border-color: #999; [cite: 10]
        }
        .table-container { overflow: auto; flex-grow: 1; position: relative; -webkit-overflow-scrolling: touch;
            [cite_start]background: #fff; [cite: 11]
        }
        table { border-collapse: collapse; table-layout: fixed; width: 0;
            [cite_start][cite: 12]
        }
        th { background: var(--header-bg);
            [cite_start]border: 1px solid var(--border-color); position: sticky; top: 0; [cite: 13]
            z-index: 20;
            font-size: 12px; font-weight: 600; user-select: none; height: var(--row-height); box-sizing: border-box;
            [cite_start][cite: 14]
        }
        .row-header { left: 0;
            [cite_start]z-index: 30; width: 50px; text-align: center; background: var(--header-bg); [cite: 15]
            cursor: context-menu;
        }
        tr:first-child th:first-child { z-index: 40;
            [cite_start][cite: 16]
        }
        td { border: 1px solid var(--border-color);
            [cite_start]padding: 0; box-sizing: border-box; height: var(--row-height); [cite: 17]
            position: relative;
        }
        
        td textarea { border: none;
            [cite_start]width: 100%; height: 100%; padding: 4px 8px; [cite: 18]
            box-sizing: border-box; outline: none; font-size: 14px; background: transparent; display: block; resize: none;
            [cite_start]font-family: inherit; white-space: pre-wrap; overflow: hidden; [cite: 19]
            -webkit-touch-callout: none;
            /* テキストエリア内は入力を許可するため選択を有効にする */
            user-select: text;
            -webkit-user-select: text;
        }
        td textarea:focus { position: absolute;
            [cite_start]top: 0; left: 0; z-index: 60; [cite: 20]
            height: auto; min-height: 100%; background: inherit; border: 2px solid var(--accent-color); padding: 3px 7px;
            [cite_start]box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden; [cite: 21]
        }
        .char-count { position: absolute;
            [cite_start]bottom: 2px; right: 4px; font-size: 9px; [cite: 22]
            color: #aaa;
            pointer-events: none; z-index: 70; background: rgba(255, 255, 255, 0.6); padding: 0 2px;
            [cite_start]border-radius: 2px; display: none; [cite: 23]
        }
        td:hover .char-count, td textarea:focus + .char-count { display: block;
            [cite_start][cite: 24]
        }

        /* --- リサイズバーの調整 --- */
        .resizer-h { position: absolute;
            [cite_start]right: -8px; top: 0; width: 16px; [cite: 25]
            height: 100%;
            cursor: col-resize; z-index: 50; touch-action: none; background: transparent;
            [cite_start][cite: 26]
        }
        .resizer-v { position: absolute;
            bottom: -8px;
            [cite_start]left: 0; width: 100%; height: 16px; [cite: 27]
            cursor: row-resize;
            z-index: 50; touch-action: none; background: transparent;
        }
        /* タップ・ホバー時にガイド線を表示 */
        .resizer-h:active::after, .resizer-h:hover::after { background: var(--accent-color);
            [cite_start]content: ''; position: absolute; right: 7px; [cite: 28]
            [cite_start]top: 0; width: 2px; height: 100%; [cite: 29]
        }
        .resizer-v:active::after, .resizer-v:hover::after { background: var(--accent-color);
            [cite_start]content: ''; position: absolute; bottom: 7px; [cite: 30]
            left: 0;
            width: 100%; height: 2px; }

        button { cursor: pointer;
            [cite_start]padding: 8px 16px; [cite: 31]
            background: #fff;
            border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; transition: all 0.2s; font-weight: 500;
            [cite_start][cite: 32]
        }
        button:hover { background: var(--accent-hover);
            [cite_start]border-color: var(--accent-color); color: var(--accent-color); [cite: 33]
        }
        .sheet-tabs { display: flex;
            [cite_start]background: var(--tab-bg); border-top: 1px solid var(--border-color); [cite: 34]
            padding: 0 10px;
            align-items: center; height: 40px; }
        .tab { padding: 8px 16px;
            [cite_start]border: 1px solid transparent; border-bottom: none; [cite: 35]
            cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; background: #e8eaed; margin-right: 2px;
            [cite_start]border-radius: 0 0 4px 4px; white-space: nowrap; [cite: 36]
        }
        .tab.active { background: #fff;
            [cite_start]border-color: var(--border-color); font-weight: bold; [cite: 37]
            border-top: 3px solid var(--accent-color); }
        .tab-close { font-size: 16px;
            [cite_start]line-height: 1; color: #888; [cite: 38]
        }
        .tab-close:hover { color: #f44336;
            [cite_start][cite: 39]
        }
        .add-sheet-btn { font-weight: bold;
            [cite_start]font-size: 18px; padding: 0 12px; height: 30px; [cite: 40]
            border: none;
            background: none; color: #5f6368; }
        .add-sheet-btn:hover { background: rgba(0,0,0,0.05); border-radius: 50%;
            [cite_start][cite: 41]
        }
        .context-menu { position: fixed;
            [cite_start]background: #fff; border: 1px solid #ccc; [cite: 42]
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            [cite_start]z-index: 1000; display: none; padding: 5px 0; min-width: 150px; [cite: 43]
        }
        .context-menu-item { padding: 8px 15px;
            [cite_start]cursor: pointer; font-size: 14px; [cite: 44]
        }
        .context-menu-item:hover { background: var(--accent-hover);
            [cite_start]color: var(--accent-color); [cite: 45]
        }
        .context-menu-item.disabled { color: #ccc;
            [cite_start]cursor: default; [cite: 46]
        }
    </style>
</head>
<body oncontextmenu="return false;"> <div class="toolbar">
    <button id="btn-add-row">行を追加 (+)</button>
    <button id="btn-add-col">列を追加 (+)</button>
    <button id="btn-export">CSV書き出し</button>
    <div class="color-palette" id="color-palette">
        <span style="font-size: 12px; color: #666; margin-right: 5px;">背景色:</span>
    </div>
</div>

<div class="table-container">
    <table id="spreadsheet">
        <thead><tr id="header-row"><th class="row-header"></th></tr></thead>
        <tbody id="table-body"></tbody>
    </table>
</div>

<div class="sheet-tabs" id="sheet-tabs">
    <button class="add-sheet-btn" id="btn-add-sheet">+</button>
</div>

<div id="context-menu" class="context-menu"></div>

<script>
    
    /** --- 定数 & 設定 --- **/
    const DB_CONFIG = { name: 'SpreadsheetDB', version: 1, store: 'settings' };
    [cite_start][cite: 47]
    const DEFAULT_COL_WIDTH = 100;
    [cite_start]const COLORS = [ [cite: 48]
        "#fff0f6", "#ffdeeb", "#f06595", "#fff5f5", "#ffc9c9", "#fa5252",
        "#fff9db", "#ffec99", "#fab005", "#ebfbee", "#b2f2bb", "#40c057",
        "#e7f5ff", "#a5d8ff", "#228be6", "#f8f0fc", "#eebefa", "#be4bdb",
        "#ffffff", "#ced4da", "#343a40"
    [cite_start]]; [cite: 49]

    /** --- 状態管理 --- **/
    [cite_start]let db; [cite: 50]
    const AppState = {
        sheets: [{ name: "シート1", data: [], rowCount: 20, colCount: 10, colWidths: [], rowHeights: [], colors: {} }],
        activeSheetIndex: 0,
        lastFocusedCell: null,
        clipboard: { type: null, index: null, data: null, heightOrWidth: null, colors: null },
        
        [cite_start]get currentSheet() { return this.sheets[this.activeSheetIndex]; [cite: 51]
        }
    };
    const DOM = {
        headerRow: document.getElementById('header-row'),
        tableBody: document.getElementById('table-body'),
        tabContainer: document.getElementById('sheet-tabs'),
        colorPalette: document.getElementById('color-palette'),
        contextMenu: document.getElementById('context-menu')
    [cite_start]}; [cite: 52]

    /** --- データベース操作 --- **/
    const DB = {
        init() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);
                req.onupgradeneeded = (e) => {
                  
                  if (!e.target.result.objectStoreNames.contains(DB_CONFIG.store)) {
                        [cite_start]e.target.result.createObjectStore(DB_CONFIG.store); [cite: 53]
                    }
                };
                req.onsuccess = (e) => { db = e.target.result; resolve(); };
         
                [cite_start]req.onerror = reject; [cite: 54]
            [cite_start]}); [cite: 55]
        },
        async save() {
            [cite_start]if (!db) return; [cite: 56]
            const tx = db.transaction([DB_CONFIG.store], 'readwrite');
            const store = tx.objectStore(DB_CONFIG.store);
            store.put(AppState.sheets, 'sheets_data');
            [cite_start]store.put(AppState.activeSheetIndex, 'active_tab_index'); [cite: 57]
        },
        async load() {
            [cite_start]if (!db) return; [cite: 58]
            const tx = db.transaction([DB_CONFIG.store], 'readonly');
            const store = tx.objectStore(DB_CONFIG.store);
            [cite_start]const data = await this._get(store, 'sheets_data'); [cite: 59]
            const index = await this._get(store, 'active_tab_index');
            if (data) AppState.sheets = data;
            [cite_start]if (index !== undefined) AppState.activeSheetIndex = index; [cite: 60]
        },
        _get(store, key) {
            return new Promise(res => {
                const req = store.get(key);
                req.onsuccess = () => res(req.result);
            [cite_start]}); [cite: 61]
        }
    };

    /** --- ユーティリティ --- **/
    const Utils = {
        getColName(n) {
            [cite_start]let name = ""; [cite: 62]
            while (n >= 0) {
                [cite_start]name = String.fromCharCode((n % 26) + 65) + name; [cite: 63]
                n = Math.floor(n / 26) - 1;
            }
            [cite_start]return name; [cite: 64]
        },
        deepCopy(obj) { return JSON.parse(JSON.stringify(obj));
        }
    [cite_start]}; [cite: 65]

    /** --- コア機能: テーブル描画 --- **/
    function renderTable() {
        [cite_start]const sheet = AppState.currentSheet; [cite: 66]
        DOM.headerRow.innerHTML = '<th class="row-header"></th>';
        DOM.tableBody.innerHTML = '';
        [cite_start]for (let i = 0; i < sheet.colCount; i++) createColHeader(i, sheet.colWidths[i]); [cite: 67]
        for (let i = 0; i < sheet.rowCount; i++) createRow(i, sheet.rowHeights[i]);
        [cite_start]renderTabs(); [cite: 68]
    }

    function createColHeader(index, width) {
        [cite_start]const th = document.createElement('th'); [cite: 69]
        th.style.width = (width || DEFAULT_COL_WIDTH) + 'px';
        th.innerHTML = `<span>${Utils.getColName(index)}</span>`;
        th.oncontextmenu = (e) => { e.preventDefault(); showContextMenu(e, 'col', index); [cite_start]}; [cite: 70]
        const resizer = document.createElement('div');
        resizer.className = 'resizer-h';
        resizer.addEventListener('mousedown', initResizeCol);
        resizer.addEventListener('touchstart', initResizeCol, {passive: false});
        th.appendChild(resizer);
        [cite_start]DOM.headerRow.appendChild(th); [cite: 71]
    }

    function createRow(rowIndex, height) {
        [cite_start]const tr = document.createElement('tr'); [cite: 72]
        if (height) tr.style.height = height + 'px';
        
        const th = document.createElement('th');
        th.className = 'row-header';
        [cite_start]th.innerText = rowIndex + 1; [cite: 73]
        th.oncontextmenu = (e) => { e.preventDefault(); showContextMenu(e, 'row', rowIndex); };
        const resizer = document.createElement('div');
        resizer.className = 'resizer-v';
        resizer.addEventListener('mousedown', initResizeRow);
        [cite_start]resizer.addEventListener('touchstart', initResizeRow, {passive: false}); [cite: 74]
        th.appendChild(resizer);
        tr.appendChild(th);
        
        const sheet = AppState.currentSheet;
        [cite_start]if (!sheet.data[rowIndex]) sheet.data[rowIndex] = []; [cite: 75]
        for (let i = 0; i < sheet.colCount; i++) {
            [cite_start]const val = sheet.data[rowIndex][i] || [cite: 76] "";
            const color = sheet.colors[`${rowIndex}-${i}`] || "#ffffff";
            tr.appendChild(createCell(rowIndex, i, val, color));
        }
        [cite_start]DOM.tableBody.appendChild(tr); [cite: 77]
    }

    function createCell(r, c, value, color) {
        [cite_start]const td = document.createElement('td'); [cite: 78]
        td.style.backgroundColor = color;
        
        const textarea = document.createElement('textarea');
        textarea.setAttribute('autocomplete', 'off');
        textarea.setAttribute('spellcheck', 'false');
        textarea.value = value;
        
        [cite_start]const countSpan = document.createElement('span'); [cite: 79]
        countSpan.className = 'char-count';
        updateCharCount(countSpan, value);
        textarea.addEventListener('input', function() {
            autoResize(this);
            AppState.currentSheet.data[r][c] = this.value;
            updateCharCount(countSpan, this.value);
            DB.save();
        [cite_start]}); [cite: 80]
        textarea.addEventListener('focus', function() {
            autoResize(this);
            AppState.lastFocusedCell = { r, c, element: td };
        [cite_start]}); [cite: 81]
        textarea.addEventListener('blur', function() { this.style.height = '100%'; });
        
        td.appendChild(textarea);
        td.appendChild(countSpan);
        [cite_start]return td; [cite: 82]
    }

    /** --- UI操作系 --- **/
    function updateCharCount(span, text) {
        [cite_start]const count = text ? [cite: 83] text.length : 0;
        span.innerText = count;
        span.style.display = count > 0 ? [cite_start]'' : 'none'; [cite: 84]
    }

    function autoResize(el) {
        [cite_start]el.style.height = 'auto'; [cite: 85]
        el.style.height = el.scrollHeight + 'px';
    }

    function applyColor(color) {
        if (AppState.lastFocusedCell) {
            [cite_start]const { r, c, element } = AppState.lastFocusedCell; [cite: 86]
            element.style.backgroundColor = color;
            AppState.currentSheet.colors[`${r}-${c}`] = color;
            DB.save();
        }
    }

    /** --- コンテキストメニュー & 編集操作 --- **/
    function showContextMenu(e, type, index) {
        [cite_start]e.preventDefault(); [cite: 87]
        DOM.contextMenu.innerHTML = '';
        const items = [
            { label: '前に挿入', action: () => modifyItems('insert', type, index) },
            { label: '削除', action: () => modifyItems('delete', type, index) },
            { label: '切り取り', action: () => modifyItems('cut', type, index) },
            { label: '手前に貼り付け', action: () => modifyItems('paste', type, index), 
              disabled: !AppState.clipboard.type || [cite_start]AppState.clipboard.type !== type } [cite: 88]
        [cite_start]]; [cite: 89]
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = `context-menu-item ${item.disabled ? 'disabled' : ''}`;
            div.innerText = item.label;
            if (!item.disabled) div.onclick = () => { item.action(); hideContextMenu(); };
            DOM.contextMenu.appendChild(div);
        [cite_start]}); [cite: 90]
        DOM.contextMenu.style.display = 'block';
        DOM.contextMenu.style.left = e.clientX + 'px';
        [cite_start]DOM.contextMenu.style.top = e.clientY + 'px'; [cite: 91]
    }

    [cite_start]function hideContextMenu() { DOM.contextMenu.style.display = 'none'; [cite: 92]
    }

    async function modifyItems(mode, type, index) {
        [cite_start]const sheet = AppState.currentSheet; [cite: 93]
        if (mode === 'insert') {
            if (type === 'row') {
                [cite_start]sheet.data.splice(index, 0, []); [cite: 94]
                sheet.rowHeights.splice(index, 0, null);
                shiftColors('row', index, 1);
                sheet.rowCount++;
            } else {
                [cite_start]sheet.data.forEach(row => row.splice(index, 0, "")); [cite: 95]
                sheet.colWidths.splice(index, 0, null);
                shiftColors('col', index, 1);
                sheet.colCount++;
            }
        } else if (mode === 'delete') {
            if (type === 'row' && sheet.rowCount > 1) {
                [cite_start]sheet.data.splice(index, 1); [cite: 96]
                sheet.rowHeights.splice(index, 1);
                deleteColors(type, index);
                shiftColors('row', index + 1, -1);
                [cite_start]sheet.rowCount--; [cite: 97]
            } else if (type === 'col' && sheet.colCount > 1) {
                [cite_start]sheet.data.forEach(row => row.splice(index, 1)); [cite: 98]
                sheet.colWidths.splice(index, 1);
                deleteColors(type, index);
                shiftColors('col', index + 1, -1);
                [cite_start]sheet.colCount--; [cite: 99]
            }
        } else if (mode === 'cut') {
            AppState.clipboard = {
                type, index,
                [cite_start]data: type === 'row' ? [cite: 100] Utils.deepCopy(sheet.data[index]) : sheet.data.map(r => r[index]),
                [cite_start]heightOrWidth: type === 'row' ? [cite: 101] sheet.rowHeights[index] : sheet.colWidths[index],
                colors: extractColors(type, index)
            [cite_start]}; [cite: 102]
            await modifyItems('delete', type, index);
            return;
        } else if (mode === 'paste') {
            if (type === 'row') {
                [cite_start]sheet.data.splice(index, 0, AppState.clipboard.data); [cite: 103]
                sheet.rowHeights.splice(index, 0, AppState.clipboard.heightOrWidth);
                shiftColors('row', index, 1);
                applyExtractedColors('row', index, AppState.clipboard.colors);
                [cite_start]sheet.rowCount++; [cite: 104]
            } else {
                [cite_start]sheet.data.forEach((row, i) => row.splice(index, 0, AppState.clipboard.data[i] || "")); [cite: 105]
                sheet.colWidths.splice(index, 0, AppState.clipboard.heightOrWidth);
                shiftColors('col', index, 1);
                applyExtractedColors('col', index, AppState.clipboard.colors);
                [cite_start]sheet.colCount++; [cite: 106]
            }
            [cite_start]AppState.clipboard = { type: null, index: null, data: null }; [cite: 107]
        }
        DB.save();
        [cite_start]renderTable(); [cite: 108]
    }

    /** --- カラー操作補助 --- **/
    function shiftColors(type, startIndex, delta) {
        [cite_start]const sheet = AppState.currentSheet; [cite: 109]
        const newColors = {};
        Object.keys(sheet.colors).forEach(key => {
            let [r, c] = key.split('-').map(Number);
            if (type === 'row' && r >= startIndex) r += delta;
            if (type === 'col' && c >= startIndex) c += delta;
            if (r >= 0 && c >= 0) newColors[`${r}-${c}`] = sheet.colors[key];
        [cite_start]}); [cite: 110]
        sheet.colors = newColors;
    }

    function deleteColors(type, index) {
        [cite_start]const sheet = AppState.currentSheet; [cite: 111]
        Object.keys(sheet.colors).forEach(key => {
            const [r, c] = key.split('-').map(Number);
            if ((type === 'row' && r === index) || (type === 'col' && c === index)) delete sheet.colors[key];
        [cite_start]}); [cite: 112]
    }

    function extractColors(type, index) {
        [cite_start]const sheet = AppState.currentSheet; [cite: 113]
        const extracted = {};
        Object.keys(sheet.colors).forEach(key => {
            const [r, c] = key.split('-').map(Number);
            if (type === 'row' && r === index) extracted[c] = sheet.colors[key];
            if (type === 'col' && c === index) extracted[r] = sheet.colors[key];
        [cite_start]}); [cite: 114]
        return extracted;
    }

    function applyExtractedColors(type, index, colorMap) {
        [cite_start]if (!colorMap) return; [cite: 115]
        const sheet = AppState.currentSheet;
        Object.keys(colorMap).forEach(key => {
            const pos = Number(key);
            const k = type === 'row' ? `${index}-${pos}` : `${pos}-${index}`;
            sheet.colors[k] = colorMap[key];
        [cite_start]}); [cite: 116]
    }

    /** --- シート管理 --- **/
    function renderTabs() {
        [cite_start]DOM.tabContainer.querySelectorAll('.tab').forEach(t => t.remove()); [cite: 117]
        AppState.sheets.forEach((sheet, index) => {
            const tab = document.createElement('div');
            tab.className = `tab ${index === AppState.activeSheetIndex ? 'active' : ''}`;
            
            const nameSpan = document.createElement('span');
            nameSpan.innerText = sheet.name;
           
            nameSpan.onclick = () => switchSheet(index);
            [cite_start]nameSpan.ondblclick = () => renameSheet(index); [cite: 118]
            
            tab.appendChild(nameSpan);

            if (AppState.sheets.length > 1) {
                const closeBtn = document.createElement('span');
                closeBtn.className = 'tab-close';
                [cite_start]closeBtn.innerHTML = '×'; [cite: 119]
                closeBtn.onclick = (e) => { e.stopPropagation(); deleteSheet(index); };
                tab.appendChild(closeBtn);
            }
            
            DOM.tabContainer.insertBefore(tab, DOM.tabContainer.querySelector('#btn-add-sheet'));
    
        [cite_start]}); [cite: 120]
    }

    function renameSheet(index) {
        [cite_start]const newName = prompt("新しいシート名を入力してください:", AppState.sheets[index].name); [cite: 121]
        if (newName && newName.trim() !== "") {
            [cite_start]AppState.sheets[index].name = newName.trim(); [cite: 122]
            DB.save();
            renderTabs();
        }
    }

    function switchSheet(index) {
        [cite_start]AppState.activeSheetIndex = index; [cite: 123]
        AppState.lastFocusedCell = null;
        DB.save();
        renderTable();
    }

    function deleteSheet(index) {
        [cite_start]if (AppState.sheets.length <= 1) return; [cite: 124]
        if (confirm(`${AppState.sheets[index].name} を削除しますか？`)) {
            [cite_start]AppState.sheets.splice(index, 1); [cite: 125]
            if (AppState.activeSheetIndex >= AppState.sheets.length) AppState.activeSheetIndex = AppState.sheets.length - 1;
            DB.save();
            [cite_start]renderTable(); [cite: 126]
        }
    }

    /** --- リサイズ機能 --- **/
    [cite_start]const getPos = e => ({ x: e.touches ? e.touches[0].clientX : e.clientX, y: e.touches ? e.touches[0].clientY : e.clientY }); [cite: 127]
    function initResizeCol(e) {
        if (e.cancelable) e.preventDefault();
        [cite_start]const resizer = e.target; [cite: 128]
        const th = resizer.parentElement;
        const colIdx = Array.from(th.parentElement.children).indexOf(th) - 1;
        const start = getPos(e);
        [cite_start]const startWidth = th.offsetWidth; [cite: 129]
        const onMove = (ev) => {
            [cite_start]const newWidth = startWidth + getPos(ev).x - start.x; [cite: 130]
            if (newWidth > 40) {
                [cite_start]th.style.width = th.style.minWidth = newWidth + 'px'; [cite: 131]
                AppState.currentSheet.colWidths[colIdx] = newWidth;
            }
        [cite_start]}; [cite: 132]
        const onEnd = () => {
            DB.save();
            [cite_start]document.removeEventListener('mousemove', onMove); [cite: 133]
            document.removeEventListener('mouseup', onEnd);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onEnd);
        };
        document.addEventListener('mousemove', onMove); 
        document.addEventListener('mouseup', onEnd);
        document.addEventListener('touchmove', onMove, {passive: false}); 
        [cite_start]document.addEventListener('touchend', onEnd); [cite: 134]
    }

    function initResizeRow(e) {
        [cite_start]if (e.cancelable) e.preventDefault(); [cite: 135]
        const resizer = e.target;
        const tr = resizer.parentElement.parentElement;
        const rowIdx = Array.from(tr.parentElement.children).indexOf(tr);
        const start = getPos(e);
        [cite_start]const startHeight = tr.offsetHeight; [cite: 136]
        const onMove = (ev) => {
            [cite_start]const newHeight = startHeight + getPos(ev).y - start.y; [cite: 137]
            if (newHeight > 20) {
                [cite_start]tr.style.height = newHeight + 'px'; [cite: 138]
                AppState.currentSheet.rowHeights[rowIdx] = newHeight;
            }
        [cite_start]}; [cite: 139]
        const onEnd = () => {
            DB.save();
            [cite_start]document.removeEventListener('mousemove', onMove); [cite: 140]
            document.removeEventListener('mouseup', onEnd);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('touchend', onEnd);
        };
        document.addEventListener('mousemove', onMove); 
        document.addEventListener('mouseup', onEnd);
        document.addEventListener('touchmove', onMove, {passive: false}); 
        [cite_start]document.addEventListener('touchend', onEnd); [cite: 141]
    }

    /** --- 外部出力 --- **/
    function exportCSV() {
        [cite_start]const sheet = AppState.currentSheet; [cite: 142]
        let csv = "";
        for (let i = 0; i < sheet.rowCount; i++) {
            [cite_start]let rowData = []; [cite: 143]
            for (let j = 0; j < sheet.colCount; j++) {
                [cite_start]let val = (sheet.data[i] && sheet.data[i][j]) ? [cite: 144] sheet.data[i][j] : "";
                rowData.push(`"${val.replace(/"/g, '""')}"`);
            }
            csv += rowData.join(",") + "\r\n";
        }
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${sheet.name}_${Date.now()}.csv`;
       
        [cite_start]link.click(); [cite: 145]
    }

    /** --- 初期化ルーチン --- **/
    async function initApp() {
        COLORS.forEach(color => {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch';
            swatch.style.backgroundColor = color;
            swatch.onclick = () => applyColor(color);
         
            [cite_start]DOM.colorPalette.appendChild(swatch); [cite: 146]
        });

        document.getElementById('btn-add-row').onclick = () => {
            createRow(AppState.currentSheet.rowCount++, null);
            DB.save();
        };
        document.getElementById('btn-add-col').onclick = () => {
            [cite_start]const sheet = AppState.currentSheet; [cite: 147]
            createColHeader(sheet.colCount++, null);
            Array.from(DOM.tableBody.rows).forEach((row, rIdx) => {
                row.appendChild(createCell(rIdx, sheet.colCount - 1, "", "#ffffff"));
            [cite_start]}); [cite: 148]
            DB.save();
        };
        document.getElementById('btn-export').onclick = exportCSV;
        document.getElementById('btn-add-sheet').onclick = () => {
            [cite_start]AppState.sheets.push({ name: `シート${AppState.sheets.length + 1}`, data: [], rowCount: 20, colCount: 10, colWidths: [], rowHeights: [], colors: {} }); [cite: 149]
            AppState.activeSheetIndex = AppState.sheets.length - 1;
            DB.save();
            renderTable();
        };
        [cite_start]document.addEventListener('click', hideContextMenu); [cite: 150]
        try {
            await DB.init();
            [cite_start]await DB.load(); [cite: 151]
        } catch (e) { console.error("DB Load Error", e);
        }
        [cite_start]renderTable(); [cite: 152]
        if ('serviceWorker' in navigator) {
            [cite_start]navigator.serviceWorker.register('sw.js').catch(console.error); [cite: 153]
        }

        // iOSやブラウザのダブルタップズームを防止するためのスクリプト
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    }

    initApp();
</script>

</body>
</html>
